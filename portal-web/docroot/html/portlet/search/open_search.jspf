<%--
/**
 * Copyright (c) 2000-present Liferay, Inc. All rights reserved.
 *
 * This library is free software; you can redistribute it and/or modify it under
 * the terms of the GNU Lesser General Public License as published by the Free
 * Software Foundation; either version 2.1 of the License, or (at your option)
 * any later version.
 *
 * This library is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more
 * details.
 */
--%>

<aui:button-row>
	<aui:button onClick='<%= renderResponse.getNamespace() + "addSearchProvider();" %>' value='<%= LanguageUtil.format(request, "add-x-as-a-search-provider", HtmlUtil.escape(company.getName()), false) %>' />
</aui:button-row>

<%
List<String> modelResources = new ArrayList<String>();

List<OpenSearch> openSearchInstances = OpenSearchRegistryUtil.getOpenSearchInstances();

Iterator<OpenSearch> itr = openSearchInstances.iterator();

while (itr.hasNext()) {
	OpenSearch openSearch = itr.next();

	if (!openSearch.isEnabled()) {
		itr.remove();

		continue;
	}

	modelResources.add(ResourceActionsUtil.getModelResource(locale, openSearch.getClassName()));
}

String primarySearch = ParamUtil.getString(request, "primarySearch");

if (Validator.isNotNull(primarySearch)) {
	portalPreferences.setValue(PortletKeys.SEARCH, "primary-search", primarySearch);
}
else {
	primarySearch = portalPreferences.getValue(PortletKeys.SEARCH, "primary-search", StringPool.BLANK);
}

if (Validator.isNotNull(primarySearch)) {
	for (int i = 0; i < openSearchInstances.size(); i++) {
		OpenSearch openSearch = openSearchInstances.get(i);

		if (primarySearch.equals(openSearch.getClassName())) {
			if (i != 0) {
				openSearchInstances.remove(i);

				openSearchInstances.add(0, openSearch);
			}

			break;
		}
	}
}
%>

<div class="search-msg">
	<c:choose>
		<c:when test="<%= modelResources.isEmpty() %>">
			<liferay-ui:message key="no-portlets-were-searched" />
		</c:when>
		<c:otherwise>
			<liferay-ui:message key="searched" /> <%= StringUtil.merge(modelResources, StringPool.COMMA_AND_SPACE) %>
		</c:otherwise>
	</c:choose>
</div>

<%
int totalResults = 0;

for (int i = 0; i < openSearchInstances.size(); i++) {
	OpenSearch openSearch = openSearchInstances.get(i);

	boolean filterSearch = false;

	if (openSearch instanceof HitsOpenSearchImpl) {
		HitsOpenSearchImpl hitsOpenSearchImpl = (HitsOpenSearchImpl)openSearch;

		Indexer hitsOpenSearchImplIndexer = hitsOpenSearchImpl.getIndexer();

		filterSearch = hitsOpenSearchImplIndexer.isFilterSearch();
	}

	int delta = 5;

	if (Validator.isNotNull(primarySearch) && primarySearch.equals(openSearch.getClassName())) {
		delta = ParamUtil.getInteger(request, SearchContainer.DEFAULT_DELTA_PARAM + i, SearchContainer.DEFAULT_DELTA);
	}

	SearchContainer openSearchSearchContainer = new SearchContainer(renderRequest, null, null, SearchContainer.DEFAULT_CUR_PARAM + i, delta, portletURL, null, LanguageUtil.format(request, "no-results-were-found-that-matched-the-keywords-x", "<strong>" + HtmlUtil.escape(keywords) + "</strong>", false));

	String xml = openSearch.search(request, groupId, themeDisplay.getUserId(), keywords, openSearchSearchContainer.getCur(), openSearchSearchContainer.getDelta(), format);

	LinkedHashMap<String, Object> groupParams = new LinkedHashMap<String, Object>();

	groupParams.put("active", Boolean.FALSE);

	int inactiveGroupsCount = GroupLocalServiceUtil.searchCount(themeDisplay.getCompanyId(), null, null, groupParams);

	Tuple tuple = com.liferay.portlet.search.util.SearchUtil.getElements(xml, openSearch.getClassName(), inactiveGroupsCount);

	List<Element> resultRows = (List<Element>)tuple.getObject(0);
	int totalRows = (Integer)tuple.getObject(1);
%>

	<c:if test="<%= !resultRows.isEmpty() %>">

		<%
		totalResults = totalResults + totalRows;
		%>

		<liferay-ui:search-container
			searchContainer='<%= openSearchSearchContainer %>'
		>
			<liferay-ui:search-container-results
				results="<%= resultRows %>"
				total="<%= totalRows %>"
			/>
			<div class="section-title">

				<%
				// When the total is <= to the delta, we know the result is accurate
				// since we've filtered the entire result set. Otherwise, we simply
				// indicate that there are possibly many more. (ï¿½ la Google)
				%>

				<c:choose>
					<c:when test="<%= filterSearch && (searchContainer.getTotal() > searchContainer.getDelta())%>">
						<%= ResourceActionsUtil.getModelResource(locale, openSearch.getClassName()) %> (<%= searchContainer.getDelta()%> <liferay-ui:message key="of-many" />)
					</c:when>
					<c:otherwise>
						<%= ResourceActionsUtil.getModelResource(locale, openSearch.getClassName()) %> (<%= searchContainer.getTotal() %>)
					</c:otherwise>
				</c:choose>
			</div>

			<liferay-ui:search-container-row
				className="com.liferay.portal.kernel.xml.Element"
				modelVar="element"
			>
				<liferay-ui:search-container-column-text>

					<%
					String entryTitle = element.elementText("title");
					String summary = element.elementText("summary");
					String entryClassName = element.elementText("entryClassName");
					long entryClassPK = GetterUtil.getLong(element.elementText("entryClassPK"));

					PortletURL viewFullContentURL = renderResponse.createRenderURL();

					viewFullContentURL.setParameter("struts_action", "/search/view_content");
					viewFullContentURL.setParameter("redirect", currentURL);

					AssetEntry assetEntry = AssetEntryLocalServiceUtil.getEntry(entryClassName, entryClassPK);

					AssetRendererFactory assetRendererFactory = AssetRendererFactoryRegistryUtil.getAssetRendererFactoryByClassName(entryClassName);

					viewFullContentURL.setParameter("assetEntryId", String.valueOf(assetEntry.getEntryId()));
					viewFullContentURL.setParameter("type", assetRendererFactory.getType());
					viewFullContentURL.setPortletMode(PortletMode.VIEW);
					viewFullContentURL.setWindowState(WindowState.MAXIMIZED);
					%>

					<a class="entry-title" href="<%= viewFullContentURL.toString()%>">
						<%= SearchUtil.highlight(HtmlUtil.escape(entryTitle), queryTerms) %>
					</a>

					<c:if test="<%= Validator.isNotNull(summary) %>">
						<br />

						<%= SearchUtil.highlight(HtmlUtil.escape(summary), queryTerms) %>
					</c:if>

					<br />

					<%
					String tagsString = element.elementText("tags");

					tagsString = tagsString.replaceAll("[\\[\\]]","");

					String[] tags = StringUtil.split(tagsString);

					String[] tagsQueryTerms = queryTerms;

					if (StringUtil.startsWith(keywords, Field.ASSET_TAG_NAMES + StringPool.COLON)) {
						tagsQueryTerms = new String[] {StringUtil.replace(keywords, Field.ASSET_TAG_NAMES + StringPool.COLON, StringPool.BLANK)};
					}

					for (int k = 0; k < tags.length; k++) {
						String tag = tags[k];

						String newKeywords = tag.trim();

						if (newKeywords.matches(".+\\s.+")) {
							newKeywords = StringPool.QUOTE + tag + StringPool.QUOTE;
						}

						PortletURL tagURL = PortletURLUtil.clone(portletURL, renderResponse);

						tagURL.setParameter("keywords", Field.ASSET_TAG_NAMES + StringPool.COLON + newKeywords);
						tagURL.setParameter("format", format);
					%>

						<c:if test="<%= k == 0 %>">
							<div class="entry-tags">
								<div class="taglib-asset-tags-summary">
						</c:if>

						<a class="tag" href="<%= tagURL.toString() %>">
							<%= SearchUtil.highlight(tag, tagsQueryTerms) %>
						</a>

						<c:if test="<%= (k + 1) == tags.length %>">
								</div>
							</div>
						</c:if>

					<%
					}
					%>

				</liferay-ui:search-container-column-text>
			</liferay-ui:search-container-row>

			<liferay-ui:search-iterator paginate="<%= false %>" />

			<c:choose>
				<c:when test="<%= (searchContainer.getTotal() == resultRows.size()) || (Validator.isNotNull(primarySearch) && openSearch.getClassName().equals(primarySearch)) %>">
					<div class="search-paginator-container">
						<liferay-ui:search-paginator searchContainer="<%= searchContainer %>" type="more" />
					</div>
				</c:when>
				<c:otherwise>
					<div class="more-results">
						<portlet:renderURL var="moreResultsURL">
							<portlet:param name="struts_action" value="/search/search" />
							<portlet:param name="groupId" value="<%= String.valueOf(groupId) %>" />
							<portlet:param name="primarySearch" value="<%= openSearch.getClassName() %>" />
							<portlet:param name="keywords" value="<%= HtmlUtil.escape(keywords) %>" />
							<portlet:param name="format" value="<%= format %>" />
						</portlet:renderURL>

						<aui:a href="<%= moreResultsURL %>">
							<liferay-ui:message arguments="<%= ResourceActionsUtil.getModelResource(locale, openSearch.getClassName()) %>" key="more-x-results" translateArguments="<%= false %>" /> &raquo;
						</aui:a>
					</div>
				</c:otherwise>
			</c:choose>
		</liferay-ui:search-container>
	</c:if>

<%
}
%>

<c:if test="<%= totalResults == 0 %>">
	<div class="no-results">
		<%= LanguageUtil.format(request, "no-results-were-found-that-matched-the-keywords-x", "<strong>" + HtmlUtil.escape(keywords) + "</strong>", false) %>
	</div>
</c:if>

<%
String pageDescription = LanguageUtil.get(request, "search-results");

if (!modelResources.isEmpty()) {
	pageDescription = LanguageUtil.get(request, "searched") + StringPool.SPACE + StringUtil.merge(modelResources, StringPool.COMMA_AND_SPACE);
}

PortalUtil.setPageDescription(pageDescription, request);
%>