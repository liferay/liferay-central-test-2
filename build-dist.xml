<?xml version="1.0"?>

<project name="portal-dist" basedir="." default="dist" xmlns:antelope="antlib:ise.antelope.tasks">
	<import file="build.xml" />

	<target name="deploy-plugins">
		<delete includeemptydirs="true" failonerror="false">
			<fileset
				dir="${deployer.dest.dir}"
				includes="*-hook/**,*-portlet/**,*-theme/**"
			/>
		</delete>

		<java
			classname="com.liferay.portal.tools.deploy.HookDeployer"
			classpathref="project.classpath"
			fork="true"
			newenvironment="true"
		>

			<!-- Required Arguments -->

			<jvmarg value="-Dexternal-properties=com/liferay/portal/tools/dependencies/portal-tools.properties" />
			<jvmarg value="-Dliferay.lib.portal.dir=${deployer.app.server.lib.portal.dir}" />
			<jvmarg value="-Ddeployer.base.dir=${lp.plugins.dir}/dist" />
			<jvmarg value="-Ddeployer.dest.dir=${deployer.dest.dir}" />
			<jvmarg value="-Ddeployer.app.server.type=${deployer.app.server.type}" />
			<jvmarg value="-Ddeployer.unpack.war=true" />
			<jvmarg value="-Ddeployer.file.pattern=*-hook-*.war" />

			<!-- Optional Arguments -->

			<jvmarg value="-Ddeployer.tomcat.lib.dir=${app.server.tomcat.lib.global.dir}" />

			<!-- Dependent Libraries -->

			<arg value="util-java/util-java.jar" />
		</java>

		<java
			classname="com.liferay.portal.tools.deploy.PortletDeployer"
			classpathref="project.classpath"
			fork="true"
			newenvironment="true"
		>

			<!-- Required Arguments -->

			<jvmarg value="-Dexternal-properties=com/liferay/portal/tools/dependencies/portal-tools.properties" />
			<jvmarg value="-Dliferay.lib.portal.dir=${deployer.app.server.lib.portal.dir}" />
			<jvmarg value="-Ddeployer.base.dir=${lp.plugins.dir}/dist" />
			<jvmarg value="-Ddeployer.dest.dir=${deployer.dest.dir}" />
			<jvmarg value="-Ddeployer.app.server.type=${deployer.app.server.type}" />
			<jvmarg value="-Ddeployer.aui.taglib.dtd=util-taglib/classes/META-INF/liferay-aui.tld" />
			<jvmarg value="-Ddeployer.portlet.taglib.dtd=util-taglib/classes/META-INF/liferay-portlet.tld" />
			<jvmarg value="-Ddeployer.portlet-ext.taglib.dtd=util-taglib/classes/META-INF/liferay-portlet-ext.tld" />
			<jvmarg value="-Ddeployer.security.taglib.dtd=util-taglib/classes/META-INF/liferay-security.tld" />
			<jvmarg value="-Ddeployer.theme.taglib.dtd=util-taglib/classes/META-INF/liferay-theme.tld" />
			<jvmarg value="-Ddeployer.ui.taglib.dtd=util-taglib/classes/META-INF/liferay-ui.tld" />
			<jvmarg value="-Ddeployer.util.taglib.dtd=util-taglib/classes/META-INF/liferay-util.tld" />
			<jvmarg value="-Ddeployer.unpack.war=true" />
			<jvmarg value="-Ddeployer.file.pattern=*-portlet-*.war" />

			<!-- Optional Arguments -->

			<jvmarg value="-Ddeployer.tomcat.lib.dir=${app.server.tomcat.lib.global.dir}" />

			<!-- Dependent Libraries -->

			<arg value="util-bridges/util-bridges.jar" />
			<arg value="util-java/util-java.jar" />
			<arg value="util-taglib/util-taglib.jar" />
		</java>

		<java
			classname="com.liferay.portal.tools.deploy.ThemeDeployer"
			classpathref="project.classpath"
			fork="true"
			newenvironment="true"
		>

			<!-- Required Arguments -->

			<jvmarg value="-Dexternal-properties=com/liferay/portal/tools/dependencies/portal-tools.properties" />
			<jvmarg value="-Dliferay.lib.portal.dir=${deployer.app.server.lib.portal.dir}" />
			<jvmarg value="-Ddeployer.base.dir=${lp.plugins.dir}/dist" />
			<jvmarg value="-Ddeployer.dest.dir=${deployer.dest.dir}" />
			<jvmarg value="-Ddeployer.app.server.type=${deployer.app.server.type}" />
			<jvmarg value="-Ddeployer.theme.taglib.dtd=util-taglib/classes/META-INF/liferay-theme.tld" />
			<jvmarg value="-Ddeployer.util.taglib.dtd=util-taglib/classes/META-INF/liferay-util.tld" />
			<jvmarg value="-Ddeployer.unpack.war=true" />
			<jvmarg value="-Ddeployer.file.pattern=*-theme-*.war" />

			<!-- Optional Arguments -->

			<jvmarg value="-Ddeployer.tomcat.lib.dir=${app.server.tomcat.lib.global.dir}" />

			<!-- Dependent Libraries -->

			<arg value="util-java/util-java.jar" />
			<arg value="util-taglib/util-taglib.jar" />
		</java>
	</target>

	<target name="build-dist-geronimo-tomcat">
		<delete dir="${app.server.geronimo-tomcat.dir}" />

		<unzip src="${app.server.parent.dir}/geronimo-tomcat-2.1.3.zip" dest="${app.server.parent.dir}" />

		<ant dir="sql" target="rebuild-derby" inheritAll="false" />

		<parallel>
			<exec dir="${app.server.geronimo-tomcat.bin.dir}" executable="startup.bat" resolveexecutable="true" />

			<sequential>
				<sleep seconds="20" />

				<ant dir="sql" target="deploy-geronimo-tomcat-derby" inheritAll="false" />

				<sleep seconds="10" />

				<!--<java
					fork="true"
					jar="${app.server.geronimo-tomcat.dir}/bin/deployer.jar"
				>
					<arg line="${app.server.geronimo-tomcat.credentials} deploy dist/liferay-portal-${lp.version}-with-dependencies.war" />
				</java>

				<sleep seconds="60" />-->

				<exec dir="${app.server.geronimo-tomcat.bin.dir}" executable="shutdown.bat" resolveexecutable="true">
					<arg line="${app.server.geronimo-tomcat.credentials}" />
				</exec>

				<sleep seconds="10" />
			</sequential>
		</parallel>

		<echo file="app.server.${user.name}.properties">app.server.type=geronimo-tomcat</echo>

		<antcall target="deploy" inheritAll="false" />

		<delete file="app.server.${user.name}.properties" />

		<antcall target="deploy-plugins">
			<param name="deployer.dest.dir" value="${app.server.geronimo-tomcat.deploy.dir}" />
			<param name="deployer.app.server.type" value="geronimo-tomcat" />
			<param name="deployer.app.server.lib.portal.dir" value="${app.server.geronimo-tomcat.lib.portal.dir}" />
		</antcall>

		<delete>
			<fileset dir="${app.server.geronimo-tomcat.dir}/var/log" includes="*.log" />
		</delete>
	</target>

	<target name="build-dist-glassfish">
		<antcall target="build-dist-glassfish-2" />
		<antcall target="build-dist-glassfish-3" />
	</target>

	<target name="build-dist-glassfish-2">
		<antcall target="build-dist-glassfish-2-configurator" />

		<antcall target="build-dist-glassfish-2-aix" />
		<antcall target="build-dist-glassfish-2-darwin" />
		<antcall target="build-dist-glassfish-2-linux" />
  		<antcall target="build-dist-glassfish-2-sunos" />
		<antcall target="build-dist-glassfish-2-sunos_x86" />
		<antcall target="build-dist-glassfish-2-windows" />

		<delete file="liferay_configurator.jar" />
	</target>

	<target name="build-dist-glassfish-2-cmd">
		<delete dir="${app.server.glassfish.installer.dir}" />

		<java
			dir="${app.server.parent.dir}"
			fork="true"
			input="tools/servers/glassfish/input.txt"
			jar="${app.server.parent.dir}/glassfish-installer-v2.1-b60c-${glassfish.os}.jar"
			maxmemory="256m"
		>
			<arg value="-console" />
		</java>

		<copy file="liferay_configurator.jar" todir="${app.server.glassfish.addons.dir}" />

		<replace
			file="${app.server.glassfish.dir}/registry.properties"
			token="source=Glassfish"
			value="source=Liferay ${lp.version} on Glassfish 2"
		/>

		<replace
			file="${app.server.glassfish.dir}/lib/install/templates/default-domain.xml.template"
			token="&lt;jvm-options&gt;-Xmx512m&lt;/jvm-options&gt;"
			value="&lt;jvm-options&gt;-Xmx1024m&lt;/jvm-options&gt;&lt;jvm-options&gt;-XX:MaxPermSize=256m&lt;/jvm-options&gt;"
		/>

		<ant antfile="setup.xml" dir="${app.server.glassfish.installer.dir}" target="build-jarinstaller-pe">
			<property name="glassfish.class" value="glassfish.class" />
		</ant>

		<move
			file="${app.server.parent.dir}/glassfish-pe-installer.jar"
			tofile="dist/liferay-portal-glassfish-${glassfish.os}-${lp.version}.jar"
		/>
	</target>

	<target name="build-dist-glassfish-2-configurator">
		<tstamp>
			<format property="tstamp.value" pattern="yyyyMMddkkmmssSSS" />
		</tstamp>

		<copy
			file="dist/liferay-portal-${lp.version}.war"
			tofile="${tstamp.value}/liferay-portal.war"
		/>

		<ant dir="support-glassfish" target="clean" inheritAll="false" />
		<ant dir="support-glassfish" target="compile" inheritAll="false" />

		<mkdir dir="${tstamp.value}/META-INF/services" />

		<echo file="${tstamp.value}/META-INF/services/com.sun.appserv.addons.Configurator" append="false">com.liferay.support.glassfish.LiferayAddonConfigurator</echo>

		<antcall target="deploy-plugins">
			<param name="deployer.dest.dir" value="${tstamp.value}" />
			<param name="deployer.app.server.type" value="glassfish-tomcat" />
			<param name="deployer.app.server.lib.portal.dir" value="lib/portal" />
		</antcall>

		<zip destfile="liferay_configurator.jar">
			<zipfileset
				dir="${tstamp.value}"
			/>
			<zipfileset
				dir="portal-kernel"
				includes="portal-kernel.jar"
			/>
			<zipfileset
				dir="portal-service"
				includes="portal-service.jar"
			/>
			<zipfileset
				dir="lib/development"
				includes="hsql.jar,jtds.jar,mysql.jar,postgresql.jar"
			/>
			<zipfileset
				dir="lib/global"
				includes="annotations.jar,portlet.jar"
			/>
			<zipfileset
				dir="lib/portal"
				includes="log4j.jar,xercesImpl.jar"
			/>
			<zipfileset
				dir="sql"
				includes="lportal.properties,lportal.script"
			/>
			<zipfileset
				dir="tools/servers/glassfish"
				includes="update-domain.xml"
			/>
			<zipfileset
				dir="tunnel-web"
				includes="tunnel-web.war"
			/>
			<zipfileset
				dir="support-glassfish/classes"
			/>
		</zip>

		<delete dir="${tstamp.value}" />
	</target>

	<target name="build-dist-glassfish-2-aix">
		<antcall target="build-dist-glassfish-2-cmd">
			<param name="glassfish.os" value="aix" />
		</antcall>
	</target>

	<target name="build-dist-glassfish-2-darwin">
		<antcall target="build-dist-glassfish-2-cmd">
			<param name="glassfish.os" value="darwin" />
		</antcall>
	</target>

	<target name="build-dist-glassfish-2-linux">
		<antcall target="build-dist-glassfish-2-cmd">
			<param name="glassfish.os" value="linux" />
		</antcall>
	</target>

	<target name="build-dist-glassfish-2-sunos">
		<antcall target="build-dist-glassfish-2-cmd">
			<param name="glassfish.os" value="sunos" />
		</antcall>
	</target>

	<target name="build-dist-glassfish-2-sunos_x86">
		<antcall target="build-dist-glassfish-2-cmd">
			<param name="glassfish.os" value="sunos_x86" />
		</antcall>
	</target>

	<target name="build-dist-glassfish-2-windows">
		<antcall target="build-dist-glassfish-2-cmd">
			<param name="glassfish.os" value="windows" />
		</antcall>
	</target>

	<target name="build-dist-glassfish-3">
		<delete dir="${app.server.glassfish.dir}" />

		<unzip
			 src="${app.server.parent.dir}/glassfish-v3-prelude.zip"
			 dest="${app.server.parent.dir}"
		/>

		<move
			file="${app.server.parent.dir}/glassfishv3-prelude/glassfish"
			todir="${app.server.parent.dir}"
		/>

		<delete dir="${app.server.parent.dir}/glassfishv3-prelude" />

		<echo file="app.server.${user.name}.properties">app.server.type=glassfish

app.server.glassfish.version=3
app.server.glassfish.zip.name=glassfish-v3-prelude.zip
app.server.glassfish.zip.url=http://download.java.net/glassfish/v3-prelude/release/$${app.server.glassfish.zip.name}</echo>

		<ant target="deploy" inheritAll="false" />

		<delete file="app.server.${user.name}.properties" />

		<replace
			file="${app.server.glassfish.instance.dir}/config/domain.xml"
			token="&lt;jvm-options&gt;-Xmx512m&lt;/jvm-options&gt;"
			value="&lt;jvm-options&gt;-Xmx1024m&lt;/jvm-options&gt;&lt;jvm-options&gt;-XX:MaxPermSize=256m&lt;/jvm-options&gt;"
		/>

		<replace
			file="${app.server.glassfish.dir}/lib/registration/servicetag-registry.xml"
			token="GlassFish V3" value="Liferay ${lp.version} on GlassFish 3" summary="true"
		/>

		<antcall target="deploy-plugins">
			<param name="deployer.dest.dir" value="${app.server.glassfish.deploy.dir}" />
			<param name="deployer.app.server.type" value="glassfish-tomcat" />
			<param name="deployer.app.server.lib.portal.dir" value="lib/portal" />
		</antcall>
	</target>

	<target name="build-dist-jboss-tomcat">
		<antcall target="build-dist-jboss-tomcat-4.2" />
		<antcall target="build-dist-jboss-tomcat-5.0" />
	</target>

	<target name="build-dist-jboss-tomcat-4.2">
		<delete dir="${app.server.parent.dir}/jboss-tomcat-4.2.3" />

		<unzip src="${app.server.parent.dir}/jboss-tomcat-4.2.3.zip" dest="${app.server.parent.dir}" />

		<echo file="app.server.${user.name}.properties">app.server.type=jboss-tomcat</echo>

		<delete dir="${project.dir}/portal-web/classes" />

		<ant target="deploy" inheritAll="false" />

		<delete file="app.server.${user.name}.properties" />

		<antcall target="deploy-plugins">
			<param name="deployer.dest.dir" value="${app.server.jboss-tomcat.deploy.dir}" />
			<param name="deployer.app.server.type" value="jboss-tomcat" />
			<param name="deployer.app.server.lib.portal.dir" value="${app.server.jboss-tomcat.lib.portal.dir}" />
		</antcall>
	</target>

	<target name="build-dist-jboss-tomcat-5.0">
		<delete dir="${app.server.parent.dir}/jboss-tomcat-5.0.0" />

		<unzip src="${app.server.parent.dir}/jboss-tomcat-5.0.0.zip" dest="${app.server.parent.dir}" />

		<echo file="app.server.${user.name}.properties">app.server.type=jboss-tomcat

app.server.jboss-tomcat.version=5.0
app.server.jboss-tomcat.dir=${app.server.parent.dir}/jboss-tomcat-5.0.0
app.server.jboss-tomcat.classes.global.dir=$${app.server.jboss-tomcat.instance.dir}/lib
app.server.jboss-tomcat.instance.dir=$${app.server.jboss-tomcat.dir}/server/default
app.server.jboss-tomcat.lib.global.dir=$${app.server.jboss-tomcat.instance.dir}/lib</echo>

		<delete dir="${project.dir}/portal-web/classes" />

		<ant target="deploy" inheritAll="false" />

		<delete file="app.server.${user.name}.properties" />

		<antcall target="deploy-plugins">
			<param name="deployer.dest.dir" value="${app.server.parent.dir}/jboss-tomcat-5.0.0/server/default/deploy" />
			<param name="deployer.app.server.type" value="jboss-tomcat" />
			<param name="deployer.app.server.lib.portal.dir" value="${app.server.parent.dir}/jboss-tomcat-5.0.0/server/default/deploy/ROOT.war/WEB-INF/lib" />
		</antcall>
	</target>

	<target name="build-dist-jetty">
		<delete dir="${app.server.jetty.dir}" />

		<unzip src="${app.server.parent.dir}/jetty-6.1.14.zip" dest="${app.server.parent.dir}" />

		<echo file="app.server.${user.name}.properties">app.server.type=jetty</echo>

		<delete dir="${project.dir}/portal-web/classes" />

		<ant target="deploy" inheritAll="false" />

		<delete file="app.server.${user.name}.properties" />

		<antcall target="deploy-plugins">
			<param name="deployer.dest.dir" value="${app.server.jetty.deploy.dir}" />
			<param name="deployer.app.server.type" value="jetty" />
			<param name="deployer.app.server.lib.portal.dir" value="${app.server.jetty.lib.portal.dir}" />
		</antcall>
	</target>

	<target name="build-dist-jonas-jetty">
		<delete dir="${app.server.jonas-jetty.dir}" />

		<unzip src="${app.server.parent.dir}/jonas-jetty-4.10.3.zip" dest="${app.server.parent.dir}" />

		<echo file="app.server.${user.name}.properties">app.server.type=jonas-jetty</echo>

		<delete dir="${project.dir}/portal-web/classes" />

		<ant target="deploy" inheritAll="false" />

		<delete file="app.server.${user.name}.properties" />

		<antcall target="deploy-plugins">
			<param name="deployer.dest.dir" value="${app.server.jonas-jetty.deploy.dir}" />
			<param name="deployer.app.server.type" value="jonas-jetty" />
			<param name="deployer.app.server.lib.portal.dir" value="${app.server.jonas-jetty.lib.portal.dir}" />
		</antcall>
	</target>

	<target name="build-dist-jonas-tomcat">
		<delete dir="${app.server.jonas-tomcat.dir}" />

		<unzip src="${app.server.parent.dir}/jonas-tomcat-4.10.3.zip" dest="${app.server.parent.dir}" />

		<echo file="app.server.${user.name}.properties">app.server.type=jonas-tomcat</echo>

		<delete dir="${project.dir}/portal-web/classes" />

		<ant target="deploy" inheritAll="false" />

		<delete file="app.server.${user.name}.properties" />

		<antcall target="deploy-plugins">
			<param name="deployer.dest.dir" value="${app.server.jonas-tomcat.deploy.dir}" />
			<param name="deployer.app.server.type" value="jonas-tomcat" />
			<param name="deployer.app.server.lib.portal.dir" value="${app.server.jonas-tomcat.lib.portal.dir}" />
		</antcall>
	</target>

	<target name="build-dist-resin">
		<delete dir="${app.server.resin.dir}" />

		<unzip src="${app.server.parent.dir}/resin-3.1.8.zip" dest="${app.server.parent.dir}" />

		<echo file="app.server.${user.name}.properties">app.server.type=resin</echo>

		<delete dir="${project.dir}/portal-web/classes" />

		<ant target="deploy" inheritAll="false" />

		<delete file="app.server.${user.name}.properties" />

		<antcall target="deploy-plugins">
			<param name="deployer.dest.dir" value="${app.server.resin.deploy.dir}" />
			<param name="deployer.app.server.type" value="resin" />
			<param name="deployer.app.server.lib.portal.dir" value="${app.server.resin.lib.portal.dir}" />
		</antcall>
	</target>

	<target name="build-dist-sql-oracle-9">
		<ant dir="sql" target="rebuild-oracle" inheritAll="false" />
		<ant dir="sql" target="export-oracle" inheritAll="false" />

		<move file="sql/lportal.dmp" tofile="dist/liferay-portal-sql-oracle-9-${lp.version}.dmp" />
	</target>

	<target name="build-dist-sql-oracle">
		<ant dir="sql" target="rebuild-oracle" inheritAll="false" />
		<ant dir="sql" target="export-oracle" inheritAll="false" />

		<move file="sql/lportal.dmp" tofile="dist/liferay-portal-sql-oracle-${lp.version}.dmp" />
	</target>

	<target name="build-dist-tomcat">
		<delete dir="${app.server.parent.dir}/tomcat-6.0.24" />

		<unzip src="${app.server.parent.dir}/apache-tomcat-6.0.24.zip" dest="${app.server.parent.dir}">
			<mapper type="glob" from="apache-tomcat-6.0.24/*" to="tomcat-6.0.24/*"/>
		</unzip>

		<echo file="app.server.${user.name}.properties">app.server.type=tomcat</echo>

		<delete dir="${project.dir}/portal-web/classes" />

		<ant target="deploy" inheritAll="false" />

		<delete file="app.server.${user.name}.properties" />

		<antcall target="deploy-plugins">
			<param name="deployer.dest.dir" value="${app.server.parent.dir}/tomcat-6.0.24/webapps" />
			<param name="deployer.app.server.type" value="tomcat" />
			<param name="deployer.app.server.lib.portal.dir" value="${app.server.parent.dir}/tomcat-6.0.24/webapps/ROOT/WEB-INF/lib" />
		</antcall>
	</target>

	<target name="build-shelf">
		<exec dir="${project.dir}" executable="cmd.exe" os="${os.windows}">
			<arg line="/c svn update -r ${svn.revision}" />
		</exec>

		<exec dir="${lp.source.dir}" executable="cmd.exe" os="${os.windows}">
			<arg line="/c svn update -r ${svn.revision}" />
		</exec>

		<exec dir="${lp.plugins.dir}" executable="cmd.exe" os="${os.windows}">
			<arg line="/c svn update -r ${svn.revision}" />
		</exec>

		<if>
			<or>
				<equals arg1="${shelf.drive}" arg2="$${shelf.drive}" />
				<equals arg1="${shelf.path}" arg2="$${shelf.path}" />
				<equals arg1="${shelf.branch}" arg2="$${shelf.branch}" />
				<equals arg1="${shelf.version}" arg2="$${shelf.version}" />
			</or>
			<then>
				<fail>
					Please set the appropriate properties. Do not run this task unless you really
					know what you are doing as it can cause loss of data.
				</fail>
			</then>
		</if>

		<exec executable="cmd">
			<arg line="/c format /v:${shelf.version} /q /y ${shelf.drive}" />
		</exec>

		<exec executable="xcopy">
			<arg line="/e /i /q /y \bundles ${shelf.drive}\bundles" />
		</exec>

		<exec executable="xcopy">
			<arg line="/e /i /q /h /y \vanilla ${shelf.drive}\projects" />
		</exec>

		<exec executable="xcopy">
			<arg line="/e /i /q /h /y \vanilla ${shelf.drive}\vanilla" />
		</exec>

		<exec dir="${shelf.drive}\projects\liferay.public\portal\${shelf.branch}" executable="cmd.exe" os="${os.windows}">
			<arg line="/c svn --username ${svn.username} --password ${svn.password} copy -r ${svn.revision} -m ' ' ${shelf.path}/${shelf.branch} ${shelf.path}/${shelf.version}" />
		</exec>

		<exec dir="${shelf.drive}\projects\liferay.public\portal\${shelf.branch}" executable="cmd.exe" os="${os.windows}">
			<arg line="/c svn switch ${shelf.path}/${shelf.version}" />
		</exec>

		<exec dir="${shelf.drive}\vanilla\liferay.public\portal\${shelf.branch}" executable="cmd.exe" os="${os.windows}">
			<arg line="/c svn switch ${shelf.path}/${shelf.version}" />
		</exec>
	</target>

	<target name="prepare-generated-files">
		<ant dir="portal-impl" target="build-iw" inheritAll="false" />
		<ant dir="portal-impl" target="build-services" inheritAll="false" />
		<ant dir="portal-impl" target="build-wsdds" inheritAll="false" />

		<antcall target="all" />

		<ant dir="sql" target="rebuild-mysql" inheritAll="false" />

		<parallel>
			<exec dir="${app.server.tomcat.bin.dir}" executable="startup.bat" resolveexecutable="true" />

			<sequential>
				<waitfor>
					<http url="http://localhost:8080" />
				</waitfor>

				<ant dir="portal-client" target="build-client" inheritAll="false" />

				<exec dir="${app.server.tomcat.bin.dir}" executable="shutdown.bat" resolveexecutable="true" />
			</sequential>
		</parallel>
	</target>

	<target name="zip-api">
		<delete file="dist/liferay-portal-doc-${lp.version}.zip" failonerror="false" />

		<zip destfile="dist/liferay-portal-doc-${lp.version}.zip">
			<zipfileset
				dir="api"
				includes="**/*.css,**/*.gif,**/*.html"
				prefix="liferay-portal-doc-${lp.version}"
			/>
		</zip>
	</target>

	<target name="zip-db-upgrade">
		<tstamp>
			<format property="tstamp.value" pattern="yyyyMMddkkmmssSSS" />
		</tstamp>

		<mkdir dir="${tstamp.value}/lib" />

		<copy todir="${tstamp.value}">
			<fileset
				dir="tools/db-upgrade"
			/>
		</copy>

		<copy todir="${tstamp.value}/lib">
			<fileset
				dir="portal-impl"
				includes="portal-impl.jar"
			/>
			<fileset
				dir="portal-kernel"
				includes="portal-kernel.jar"
			/>
			<fileset
				dir="portal-service"
				includes="portal-service.jar"
			/>
			<fileset
				dir="lib/development"
			/>
			<fileset
				dir="lib/global"
			/>
			<fileset
				dir="lib/portal"
			/>
			<fileset
				dir="util-java"
				includes="util-java.jar"
			/>
		</copy>

		<zip destfile="dist/liferay-portal-db-upgrade-${lp.version}.zip">
			<zipfileset
				dir="${tstamp.value}"
				excludes="run.sh"
				prefix="liferay-portal-db-upgrade-${lp.version}"
			/>
			<zipfileset
				dir="${tstamp.value}"
				filemode="744"
				includes="run.sh"
				prefix="liferay-portal-db-upgrade-${lp.version}"
			/>
		</zip>

		<delete dir="${tstamp.value}" />
	</target>

	<target name="zip-executable">
		<antelope:stringutil string="${zip.executable.dir}" property="zip.executable.dir.beginindex">
			<lastindexof string="/" />
		</antelope:stringutil>

		<math
			datatype="int"
			operand1="${zip.executable.dir.beginindex}"
			operand2="1"
			operation="+"
			result="zip.executable.dir.beginindex"
		/>

		<antelope:stringutil string="${zip.executable.dir}" property="zip.executable.dir.name">
			<substring beginindex="${zip.executable.dir.beginindex}" />
		</antelope:stringutil>

		<mkdir dir="dist" />

		<zip destfile="dist/${zip.executable.file}-${lp.version}.zip">
			<zipfileset
				dir="${zip.executable.dir}"
				excludes="**/*.sh"
				prefix="liferay-portal-${lp.version}/${zip.executable.dir.name}"
			/>
			<zipfileset
				dir="${zip.executable.dir}"
				filemode="744"
				includes="**/*.sh"
				prefix="liferay-portal-${lp.version}/${zip.executable.dir.name}"
			/>
			<zipfileset
				dir="${zip.executable.dir}/../data"
				prefix="liferay-portal-${lp.version}/data"
			/>
			<zipfileset
				dir="tools/zip_tmpl"
				prefix="liferay-portal-${lp.version}"
			/>
		</zip>
	</target>

	<target name="zip-geronimo-tomcat">
		<delete file="dist/liferay-portal-geronimo-tomcat-${lp.version}.zip" failonerror="false" />

		<antcall target="zip-executable">
			<param name="zip.executable.file" value="liferay-portal-geronimo-tomcat" />
			<param name="zip.executable.dir" value="${app.server.geronimo-tomcat.dir}" />
		</antcall>
	</target>

	<target name="zip-glassfish">
		<antcall target="zip-glassfish-2" />
		<antcall target="zip-glassfish-3" />
	</target>

	<target name="zip-glassfish-2">
	</target>

	<target name="zip-glassfish-3">
		<delete file="dist/liferay-portal-glassfish-${lp.version}.zip" failonerror="false" />

		<antcall target="zip-executable">
			<param name="zip.executable.file" value="liferay-portal-glassfish" />
			<param name="zip.executable.dir" value="${app.server.glassfish.dir}" />
		</antcall>
	</target>

	<target name="zip-jboss-tomcat">
		<antcall target="zip-jboss-tomcat-4.2" />
		<antcall target="zip-jboss-tomcat-5.0" />
	</target>

	<target name="zip-jboss-tomcat-4.2">
		<delete file="dist/liferay-portal-jboss-tomcat-4.2-${lp.version}.zip" failonerror="false" />

		<antcall target="zip-executable">
			<param name="zip.executable.file" value="liferay-portal-jboss-tomcat-4.2" />
			<param name="zip.executable.dir" value="${app.server.parent.dir}/jboss-tomcat-4.2.3" />
		</antcall>
	</target>

	<target name="zip-jboss-tomcat-5.0">
		<delete file="dist/liferay-portal-jboss-tomcat-5.0-${lp.version}.zip" failonerror="false" />

		<antcall target="zip-executable">
			<param name="zip.executable.file" value="liferay-portal-jboss-tomcat-5.0" />
			<param name="zip.executable.dir" value="${app.server.parent.dir}/jboss-tomcat-5.0.0" />
		</antcall>
	</target>

	<target name="zip-jetty">
		<delete file="dist/liferay-portal-jetty-${lp.version}.zip" failonerror="false" />

		<antcall target="zip-executable">
			<param name="zip.executable.file" value="liferay-portal-jetty" />
			<param name="zip.executable.dir" value="${app.server.jetty.dir}" />
		</antcall>
	</target>

	<target name="zip-jonas">
		<antcall target="zip-jonas-jetty" />
		<antcall target="zip-jonas-tomcat" />
	</target>

	<target name="zip-jonas-jetty">
		<delete file="dist/liferay-portal-jonas-jetty-${lp.version}.zip" failonerror="false" />

		<antcall target="zip-executable">
			<param name="zip.executable.file" value="liferay-portal-jonas-jetty" />
			<param name="zip.executable.dir" value="${app.server.jonas-jetty.dir}" />
		</antcall>
	</target>

	<target name="zip-jonas-tomcat">
		<delete file="dist/liferay-portal-jonas-tomcat-${lp.version}.zip" failonerror="false" />

		<antcall target="zip-executable">
			<param name="zip.executable.file" value="liferay-portal-jonas-tomcat" />
			<param name="zip.executable.dir" value="${app.server.jonas-tomcat.dir}" />
		</antcall>
	</target>

	<target name="zip-portal-client">
		<delete file="dist/liferay-portal-client-${lp.version}.zip" failonerror="false" />

		<zip destfile="dist/liferay-portal-client-${lp.version}.zip">
			<zipfileset
				dir="lib/development"
				includes="activation.jar,mail.jar"
				prefix="liferay-portal-client-${lp.version}"
			/>
			<zipfileset
				dir="lib/portal"
				includes="axis.jar,commons-discovery.jar,commons-logging.jar,jaxrpc.jar,wsdl4j.jar"
				prefix="liferay-portal-client-${lp.version}"
			/>
			<zipfileset
				dir="portal-client"
				includes="portal-client.jar"
				prefix="liferay-portal-client-${lp.version}"
			/>
		</zip>
	</target>

	<target name="zip-portal-dependencies">
		<delete file="dist/liferay-portal-dependencies-${lp.version}.zip" failonerror="false" />

		<zip destfile="dist/liferay-portal-dependencies-${lp.version}.zip">
			<zipfileset
				dir="lib/development"
				includes="hsql.jar"
				prefix="liferay-portal-dependencies-${lp.version}"
			/>
			<zipfileset
				dir="lib/global"
				includes="*.jar"
				prefix="liferay-portal-dependencies-${lp.version}"
			/>
			<zipfileset
				dir="portal-kernel"
				includes="portal-kernel.jar"
				prefix="liferay-portal-dependencies-${lp.version}"
			/>
			<zipfileset
				dir="portal-service"
				includes="portal-service.jar"
				prefix="liferay-portal-dependencies-${lp.version}"
			/>
		</zip>
	</target>

	<target name="zip-portal-war">
		<antcall target="zip-portal-war-2.4" />
		<!--<antcall target="zip-portal-war-2.3" />-->
		<antcall target="zip-portal-war-2.4-with-dependencies" />
		<!--<antcall target="zip-portal-war-2.3-with-dependencies" />-->
	</target>

	<target name="zip-portal-war-2.3">
		<tstamp>
			<format property="tstamp.value" pattern="yyyyMMddkkmmssSSS" />
		</tstamp>

		<java
			classname="com.liferay.portal.tools.WebXML23Converter"
			classpathref="project.classpath"
			fork="true"
			maxmemory="128m"
			newenvironment="true"
		>
			<jvmarg value="-Dexternal-properties=com/liferay/portal/tools/dependencies/portal-tools.properties" />
			<jvmarg value="-Dorg.apache.commons.logging.Log=org.apache.commons.logging.impl.Log4JLogger" />
			<arg value="${app.server.portal.dir}/WEB-INF/web.xml" />
			<arg value="${tstamp.value}/WEB-INF/web.xml" />
		</java>

		<delete file="dist/liferay-portal-${lp.version}-servlet23.war" failonerror="false" />

		<copy
			file="dist/liferay-portal-${lp.version}.war"
			tofile="dist/liferay-portal-${lp.version}-servlet23.war"
			overwrite="yes"
		/>

		<zip
			basedir="${tstamp.value}"
			destfile="dist/liferay-portal-${lp.version}-servlet23.war"
			update="yes"
		/>

		<delete dir="${tstamp.value}" />
	</target>

	<target name="zip-portal-war-2.3-with-dependencies">
		<tstamp>
			<format property="tstamp.value" pattern="yyyyMMddkkmmssSSS" />
		</tstamp>

		<copy todir="${tstamp.value}/WEB-INF/lib">
			<fileset
				dir="${app.server.lib.global.dir}"
				includes="annotations.jar,portal-kernel.jar,portal-service.jar,portlet.jar"
			/>
		</copy>

		<delete file="dist/liferay-portal-${lp.version}-servlet23-with-dependencies.war" failonerror="false" />

		<copy
			file="dist/liferay-portal-${lp.version}-servlet23.war"
			tofile="dist/liferay-portal-${lp.version}-servlet23-with-dependencies.war"
			overwrite="yes"
		/>

		<zip
			basedir="${tstamp.value}"
			destfile="dist/liferay-portal-${lp.version}-servlet23-with-dependencies.war"
			update="yes"
		/>

		<delete dir="${tstamp.value}" />
	</target>

	<target name="zip-portal-war-2.4">
		<delete file="dist/liferay-portal-${lp.version}.war" failonerror="false" />

		<zip
			basedir="${app.server.portal.dir}"
			destfile="dist/liferay-portal-${lp.version}.war"
			excludes="html/js/editor/_fckeditor/**,html/js/editor/fckeditor/_samples/**"
		/>

		<tstamp>
			<format property="tstamp.value" pattern="yyyyMMddkkmmssSSS" />
		</tstamp>

		<!--
		LPS-3408
		-->

		<copy todir="${tstamp.value}/WEB-INF/lib">
			<fileset
				dir="lib/portal"
				includes="ccpp.jar"
			/>
		</copy>

		<zip
			basedir="${tstamp.value}"
			destfile="dist/liferay-portal-${lp.version}.war"
			update="yes"
		/>

		<delete dir="${tstamp.value}" />
	</target>

	<target name="zip-portal-war-2.4-with-dependencies">
		<tstamp>
			<format property="tstamp.value" pattern="yyyyMMddkkmmssSSS" />
		</tstamp>

		<copy todir="${tstamp.value}/WEB-INF/lib">
			<fileset
				dir="${app.server.lib.global.dir}"
				includes="annotations.jar,portal-kernel.jar,portal-service.jar,portlet.jar"
			/>
		</copy>

		<delete file="dist/liferay-portal-${lp.version}-with-dependencies.war" failonerror="false" />

		<copy
			file="dist/liferay-portal-${lp.version}.war"
			tofile="dist/liferay-portal-${lp.version}-with-dependencies.war"
			overwrite="yes"
		/>

		<zip
			basedir="${tstamp.value}"
			destfile="dist/liferay-portal-${lp.version}-with-dependencies.war"
			update="yes"
		/>

		<delete dir="${tstamp.value}" />
	</target>

	<target name="zip-resin">
		<delete file="dist/liferay-portal-resin-${lp.version}.zip" failonerror="false" />

		<antcall target="zip-executable">
			<param name="zip.executable.file" value="liferay-portal-resin" />
			<param name="zip.executable.dir" value="${app.server.resin.dir}" />
		</antcall>
	</target>

	<target name="zip-sql">
		<delete file="dist/liferay-portal-sql-${lp.version}.zip" failonerror="false" />

		<zip destfile="dist/liferay-portal-sql-${lp.version}.zip">
			<zipfileset
				dir="sql"
				includes="**/*.sql"
				prefix="liferay-portal-sql-${lp.version}"
			/>
		</zip>
	</target>

	<target name="zip-src">
		<delete file="dist/liferay-portal-src-${lp.version}.zip" failonerror="false" />

		<zip destfile="dist/liferay-portal-src-${lp.version}.zip">
			<zipfileset
				dir="${lp.source.dir}"
				prefix="liferay-portal-src-${lp.version}"
			/>
		</zip>
	</target>

	<target name="zip-tomcat">
		<delete file="dist/liferay-portal-tomcat-${lp.version}.zip" failonerror="false" />

		<antcall target="zip-executable">
			<param name="zip.executable.file" value="liferay-portal-tomcat" />
			<param name="zip.executable.dir" value="${app.server.tomcat.dir}" />
		</antcall>
	</target>

	<target name="dist">
		<exec dir="${project.dir}" executable="cmd.exe" os="${os.windows}">
			<arg line="/c svn update -r ${svn.revision}" />
		</exec>

		<exec dir="${lp.source.dir}" executable="cmd.exe" os="${os.windows}">
			<arg line="/c svn update -r ${svn.revision}" />
		</exec>

		<exec dir="${lp.plugins.dir}" executable="cmd.exe" os="${os.windows}">
			<arg line="/c svn update -r ${svn.revision}" />
		</exec>

		<antcall target="all" />

		<delete dir="${lp.plugins.dir}/dist" />

		<ant dir="${lp.plugins.dir}/hooks/sevencogs-hook" target="all" inheritAll="false" />
		<ant dir="${lp.plugins.dir}/portlets/chat-portlet" target="all" inheritAll="false" />
		<ant dir="${lp.plugins.dir}/portlets/google-maps-portlet" target="all" inheritAll="false" />
		<!--<ant dir="${lp.plugins.dir}/portlets/mail-portlet" target="all" inheritAll="false" />-->
		<ant dir="${lp.plugins.dir}/portlets/sn-portlet" target="all" inheritAll="false" />
		<ant dir="${lp.plugins.dir}/portlets/web-form-portlet" target="all" inheritAll="false" />
		<ant dir="${lp.plugins.dir}/themes/sevencogs-theme" target="all" inheritAll="false" />

		<delete dir="${liferay.home}/data" />
		<delete dir="${liferay.home}/deploy" />

		<antcall target="java2html" />
		<antcall target="dtddoc" />

		<delete dir="dist" />
		<mkdir dir="dist" />

		<delete dir="tools/zip_tmpl/license" />
		<mkdir dir="tools/zip_tmpl/license" />

		<copy file="copyright.txt" todir="tools/zip_tmpl/license" />
		<copy file="lib/versions.html" todir="tools/zip_tmpl/license" />

		<antcall target="zip-portal-war" />

		<antcall target="build-dist-geronimo-tomcat" />
		<antcall target="build-dist-glassfish" />
		<antcall target="build-dist-jboss-tomcat" />
		<antcall target="build-dist-jetty" />
		<antcall target="build-dist-jonas-jetty" />
		<antcall target="build-dist-jonas-tomcat" />
		<antcall target="build-dist-resin" />
		<antcall target="build-dist-tomcat" />

		<antcall target="zip-api" />
		<antcall target="zip-geronimo-tomcat" />
		<antcall target="zip-glassfish" />
		<antcall target="zip-jboss-tomcat" />
		<antcall target="zip-jetty" />
		<antcall target="zip-jonas" />
		<antcall target="zip-portal-client" />
		<antcall target="zip-portal-dependencies" />
		<antcall target="zip-resin" />
		<antcall target="zip-sql" />
		<antcall target="zip-src" />
		<antcall target="zip-tomcat" />

		<copy file="tunnel-web/tunnel-web.war" tofile="dist/liferay-portal-tunnel-web-${lp.version}.war" />

		<antcall target="build-dist-sql-oracle" />

		<ant dir="${lp.plugins.dir}" target="extract-plugins-sdk" inheritAll="false" />

		<move file="${lp.plugins.dir}/dist/liferay-plugins-sdk-${lp.version}.zip" tofile="dist/liferay-plugins-sdk-${lp.version}.zip" />

		<if>
			<not>
				<equals arg1="${dist.username}" arg2="$${dist.username}" />
			</not>
			<then>
				<scp todir="${dist.username}:${dist.password}@${dist.host}:/home/${dist.username}" trust="yes">
					<fileset dir="dist" />
				</scp>
			</then>
		</if>
	</target>
</project>