import com.liferay.gradle.util.FileUtil

buildscript {
	repositories {
		mavenLocal()

		maven {
			url "http://cdn.repository.liferay.com/nexus/content/groups/public"
		}
	}

	dependencies {
		classpath group: "com.liferay", name: "com.liferay.gradle.plugins", version: "+"
		classpath group: "com.liferay", name: "com.liferay.gradle.plugins.maven.plugin.builder", version: "1.0.2"
	}
}

buildDir = new File(rootDir.parentFile, "build")

task wrapper(type: Wrapper) {
	File wrapperDir = rootDir.parentFile

	distributionUrl = "../../tools/gradle-${gradle.gradleVersion}.LIFERAY-PATCHED-1-bin.zip"
	jarFile = new File(wrapperDir, "gradle/wrapper/gradle-wrapper.jar")
	scriptFile = new File(wrapperDir, "gradlew")
}

gradle.beforeProject {
	Project project ->

	File buildGradleFile = project.file("build.gradle")

	if (buildGradleFile.exists() && project.parent) {
		project.apply from: rootProject.file("build-module.gradle")
	}
}

gradle.taskGraph.useFilter {
	Task task ->

	if (task.name == "buildService") {
		if (!FileUtil.exists(task.project, "service.xml")) {
			return false
		}
	}
	else if (task.name == "compileJSP") {
		FileTree jspFileTree = fileTree(dir: task.project.projectDir, excludes: ["**/custom_jsps/**/*", "**/dependencies/**/*"], includes: ["docroot/**/*.jsp", "src/META-INF/resources/**/*.jsp"])

		if (jspFileTree.empty) {
			return false
		}
	}
	else if (task.name == "test") {
		if (!FileUtil.exists(task.project, "test/unit")) {
			return false
		}
	}
	else if (task.name == "testIntegration") {
		if (!FileUtil.exists(task.project, "test/integration")) {
			return false
		}
	}

	return true
}