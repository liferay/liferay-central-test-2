<?xml version="1.0"?>
<!DOCTYPE project>

<project name="build-changelog">
	<condition property="changelog.exists">
		<available file="${basedir}/module.changelog" />
	</condition>

	<extension-point name="changelog" depends="write-changelog" />

	<target name="get-changelog-header">
		<condition property="changelog.entry.spacing" value="${line.separator}${line.separator}" else="">
			<istrue value="${changelog.exists}" />
		</condition>

		<loadproperties srcFile="${basedir}/bnd.bnd" />

		<property name="changelog.header" value="${changelog.entry.spacing}#${line.separator}# Bundle Version ${Bundle-Version}${line.separator}#${line.separator}" />
	</target>

	<target name="get-git-branch" unless="${changelog.exists}">
		<exec executable="git" outputproperty="git.branch">
			<arg value="rev-parse" />
			<arg value="--abbrev-ref" />
			<arg value="HEAD" />
		</exec>
	</target>

	<target name="get-git-commit-id-last-year" unless="${changelog.exists}" depends="get-git-branch,get-last-year-date">
		<exec dir="${basedir}" executable="git" outputproperty="git.commit.id.last.year">
			<arg value="rev-list" />
			<arg value="-1" />
			<arg value="--before=&quot;${last.year.date}&quot;" />
			<arg value="${git.branch}" />
		</exec>
	</target>

	<target name="get-git-commit-id-previous" if="${changelog.exists}">
		<loadfile property="git.commit.id.previous" srcFile="${basedir}/module.changelog">
			<filterchain>
				<tokenfilter>
					<containsregex pattern="[0-9a-z]{40}" />

					<replaceregex pattern=".*\^\.\.([0-9a-z]{40})=.*" replace="\1" />
				</tokenfilter>

				<tailfilter lines="1" />
			</filterchain>
		</loadfile>
	</target>

	<target name="get-git-commit-range" depends="get-git-commit-range-end,get-git-commit-range-start">
		<property name="git.commit.range" value="${git.commit.range.start}^..${git.commit.range.end}" />
	</target>

	<target name="get-git-commit-range-end" unless="${git.commit.range.end}">
		<exec executable="git" outputproperty="git.commit.range.end">
			<arg value="rev-parse" />
			<arg value="HEAD" />
		</exec>
	</target>

	<target name="get-git-commit-range-start" depends="get-git-commit-id-last-year,get-git-commit-id-previous">
		<condition property="git.commit.range.start" value="${git.commit.id.previous}" else="${git.commit.id.last.year}">
			<isset property="git.commit.id.previous" />
		</condition>
	</target>

	<target name="get-last-year-date" unless="${changelog.exists}">
		<tstamp>
			<format offset="-1" pattern="yyyy-MM-dd" property="last.year.date" unit="year" />
		</tstamp>
	</target>

	<target name="get-ticket-list" depends="get-git-commit-range">
		<exec dir="${basedir}" executable="git" outputproperty="git.log">
			<arg value="log" />
			<arg value="--pretty=format:&quot;%s&quot;" />
			<arg value="${git.commit.range}" />
			<arg value="." />
		</exec>

		<loadresource property="ticket.list">
			<propertyresource name="git.log" />
			<filterchain>
				<tokenfilter delimOutput=" ">
					<containsregex pattern="CLDSVCS|LPS|SOS|SYNC" />

					<replaceregex pattern="((?:CLDSVCS|LPS|SOS|SYNC)-\d+).*" replace="\1" />
				</tokenfilter>
			</filterchain>
		</loadresource>

		<property name="ticket.list" value="" />
	</target>

	<target name="write-changelog" depends="get-changelog-header,get-git-commit-range,get-ticket-list">
		<echo append="true" file="${basedir}/module.changelog" message="${changelog.header}" />

		<echo append="true" file="${basedir}/module.changelog" message="${git.commit.range}=${ticket.list}" />
	</target>
</project>