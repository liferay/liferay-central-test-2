{"version":3,"sources":["/source/ImageEditor.es.js"],"names":[],"mappings":"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","sourcesContent":["import Component from 'metal-component/src/Component';\nimport Soy from 'metal-soy/src/Soy';\n\nimport core from 'metal/src/core';\nimport dom from 'metal-dom/src/dom';\nimport { CancellablePromise } from 'metal-promise/src/promise/Promise';\nimport Dropdown from 'metal-dropdown/src/Dropdown';\n\nimport ImageEditorHistoryEntry from './ImageEditorHistoryEntry.es';\nimport ImageEditorLoading from './ImageEditorLoading.es';\n\nimport templates from './ImageEditor.soy';\n\n/**\n * ImageEditor\n *\n * This class bootstraps all the necessary parts of an image editor. It only controls\n * the state and history of the editing process, orchestrating how the different parts\n * of the application work.\n *\n * All image processing is delegated to the different image editor capability implementations. The\n * editor provides:\n * - A common way of exposing the functionality.\n * - Some registration points which can be used by the image editor capability implementors\n * to provide UI controls.\n */\nclass ImageEditor extends Component {\n\t/**\n\t * @inheritDoc\n\t */\n\tconstructor(opt_config) {\n\t\tsuper(opt_config);\n\n\t\t/**\n\t \t * This index points to the current state in the history.\n\t \t *\n\t\t * @type {Number}\n\t\t * @protected\n\t\t */\n\t\tthis.historyIndex_ = 0;\n\n\t\t/**\n\t\t * History of the different image states during edition. Every\n\t\t * entry entry represents a change to the image on top of the\n\t\t * previous one.\n\t\t * - History entries are objects with\n\t\t *     - url (optional): the url representing the image\n\t\t *     - data: the ImageData object of the image\n\t \t *\n\t\t * @type {Array.<Object>}\n\t\t * @protected\n\t\t */\n\t\tthis.history_ = [\n\t\t\tnew ImageEditorHistoryEntry(\n\t\t\t\t{\n\t\t\t\t\turl: this.image\n\t\t\t\t}\n\t\t\t)\n\t\t];\n\n\t\t// Polyfill svg usage for lexicon icons\n\t\tsvg4everybody(\n\t\t\t{\n\t\t\t\tpolyfill: true\n\t\t\t}\n\t\t);\n\n\t\t// Load the first entry imageData and render it on the app.\n\t\tthis.history_[0].getImageData()\n\t\t\t.then((imageData) => this.syncImageData_(imageData));\n\t}\n\n\t/**\n\t * Accepts the current changes applied by the active control and creates\n\t * a new entry in the history stack. Doing this will wipe out any\n\t * stale redo states.\n\t */\n\taccept() {\n\t\tlet selectedControl = this.components[this.id + '_selected_control_' + this.selectedControl.variant];\n\n\t\tthis.history_[this.historyIndex_].getImageData()\n\t\t\t.then((imageData) => selectedControl.process(imageData))\n\t\t\t.then((imageData) => this.createHistoryEntry_(imageData))\n\t\t\t.then(() => this.syncHistory_())\n\t\t\t.then(() => {\n\t\t\t\tthis.selectedControl = null;\n\t\t\t\tthis.selectedTool = null;\n\t\t\t});\n\t}\n\n\t/**\n\t * Creates a new history entry state.\n\t *\n\t * @param  {ImageData} imageData The ImageData of the new image.\n\t * @protected\n\t */\n\tcreateHistoryEntry_(imageData) {\n\t\t// Push new state and discard stale redo states\n\t\tthis.historyIndex_++;\n\t\tthis.history_.length = this.historyIndex_ + 1;\n\t\tthis.history_[this.historyIndex_] = new ImageEditorHistoryEntry({data: imageData});\n\n\t\treturn CancellablePromise.resolve();\n\t}\n\n\t/**\n\t * Discards the current changes applied by the active control and reverts\n\t * the image to its state before the control activation.\n\t */\n\tdiscard() {\n\t\tthis.selectedControl = null;\n\t\tthis.selectedTool = null;\n\t\tthis.syncHistory_();\n\t}\n\n\t/**\n\t * Retrieves the editor canvas DOM node.\n\t *\n\t * @return {Element} The canvas element.\n\t */\n\tgetImageEditorCanvas() {\n\t\treturn this.element.querySelector('.lfr-image-editor-image-container canvas');\n\t}\n\n\t/**\n\t * Retrieves the ImageData representation of the current image.\n\t *\n\t * @return {CancellablePromise} A promise that will resolve with the image data.\n\t */\n\tgetImageEditorImageData() {\n\t\treturn this.history_[this.historyIndex_].getImageData();\n\t}\n\n\t/**\n\t * Updates the image back to a previously undone state in the history.\n\t * Redoing an action recovers the undone image changes and enables the\n\t * undo stack in case the user wants to undo the changes again.\n\t */\n\tredo() {\n\t\tthis.historyIndex_++;\n\t\tthis.syncHistory_();\n\t}\n\n\t/**\n\t * Selects a control and starts the edition phase for it.\n\t *\n\t * @param  {MouseEvent} event\n\t */\n\trequestImageEditorEdit(event) {\n\t\tlet controls = this.imageEditorCapabilities.tools.reduce(\n\t\t\t(prev, curr) => prev.concat(curr.controls), []);\n\n\t\tlet target = event.delegateTarget || event.currentTarget;\n\t\tlet targetControl = target.getAttribute('data-control');\n\t\tlet targetTool = target.getAttribute('data-tool');\n\n\t\tthis.syncHistory_()\n\t\t\t.then(() => {\n\t\t\t\tthis.selectedControl = controls.filter(tool => tool.variant === targetControl)[0];\n\t\t\t\tthis.selectedTool = targetTool;\n\t\t\t});\n\t}\n\n\t/**\n\t * Queues a request for a preview process of the current image by the\n\t * currently selected control.\n\t */\n\trequestImageEditorPreview() {\n\t\tlet selectedControl = this.components[this.id + '_selected_control_' + this.selectedControl.variant];\n\n\t\tthis.history_[this.historyIndex_].getImageData()\n\t\t\t.then((imageData) => selectedControl.preview(imageData))\n\t\t\t.then((imageData) => this.syncImageData_(imageData));\n\n\t\tthis.components.loading.show = true;\n\t}\n\n\t/**\n\t * Discards all changes and restores the original state of the image.\n\t * Unlike the undo/redo methods, reset will wipe out all the history.\n\t */\n\treset() {\n\t\tthis.historyIndex_ = 0;\n\t\tthis.history_.length = 1;\n\t\tthis.syncHistory_();\n\t}\n\n\t/**\n\t * Syncs the image and history values after changes to the\n\t * history stack.\n\t *\n\t * @protected\n\t */\n\tsyncHistory_() {\n\t\treturn new CancellablePromise((resolve, reject) => {\n\t\t\tthis.history_[this.historyIndex_].getImageData()\n\t\t\t\t.then((imageData) => {\n\t\t\t\t\tthis.syncImageData_(imageData);\n\n\t\t\t\t\tthis.history = {\n\t\t\t\t\t\tcanRedo: this.historyIndex_ < this.history_.length - 1,\n\t\t\t\t\t\tcanReset: this.history_.length > 1,\n\t\t\t\t\t\tcanUndo: this.historyIndex_ > 0\n\t\t\t\t\t};\n\n\t\t\t\t\tresolve();\n\t\t\t\t});\n\t\t\t});\n\t}\n\n\t/**\n\t * Updates the image data showed in the editable area\n\t *\n\t * @param  {ImageData} imageData The new ImageData value to show on the editor\n\t * @protected\n\t */\n\tsyncImageData_(imageData) {\n\t\tlet width = imageData.width;\n\t\tlet height = imageData.height;\n\n\t\tlet aspectRatio = width / height;\n\n\t\tlet offscreenCanvas = document.createElement('canvas');\n\t\toffscreenCanvas.width = width;\n\t\toffscreenCanvas.height = height;\n\n\t\tlet offscreenContext = offscreenCanvas.getContext('2d');\n\t\toffscreenContext.clearRect(0, 0, width, height);\n\t\toffscreenContext.putImageData(imageData, 0, 0);\n\n\t\tlet canvas = this.getImageEditorCanvas();\n\n\t\tlet boundingBox = dom.closest(this.element, '#main-content');\n\t\tlet availableWidth = boundingBox.offsetWidth;\n\t\tlet availableHeight = boundingBox.offsetHeight - 142 - 40;\n\t\tlet availableAspectRatio = availableWidth / availableHeight;\n\n\t\tif (availableAspectRatio > 1) {\n\t\t\tcanvas.height = availableHeight;\n\t\t\tcanvas.width = aspectRatio * availableHeight;\n\t\t} else {\n\t\t\tcanvas.width = availableWidth;\n\t\t\tcanvas.height = availableWidth / aspectRatio;\n\t\t}\n\n\t\tlet context = canvas.getContext('2d');\n\t\tcontext.clearRect(0, 0, canvas.width, canvas.height);\n\t\tcontext.drawImage(offscreenCanvas, 0, 0, width, height, 0, 0, canvas.width, canvas.height);\n\n\t\tcanvas.style.width = canvas.width + 'px';\n\t\tcanvas.style.height = canvas.height + 'px';\n\n\t\tthis.components.loading.show = false;\n\t}\n\n\t/**\n\t * Reverts the image to the previous state in the history. Undoing\n\t * an action brings back the previous version of the image and enables\n\t * the redo stack in case the user wants to reapply the change again.\n\t */\n\tundo() {\n\t\tthis.historyIndex_--;\n\t\tthis.syncHistory_();\n\t}\n}\n\n// Register component\nSoy.register(ImageEditor, templates);\n\nexport default ImageEditor;"]}