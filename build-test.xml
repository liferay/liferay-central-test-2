<?xml version="1.0"?>

<project name="portal-test" basedir="." default="test" xmlns:antelope="antlib:ise.antelope.tasks">
	<import file="build.xml" />

	<property file="${project.dir}/test.${user.name}.properties" />
	<property file="${project.dir}/test.${env.COMPUTERNAME}.properties" />
	<property file="${project.dir}/test.properties" />

	<propertycopy name="db.host" from="db.${db.type}.host" silent="true" />
	<propertycopy name="db.driver" from="db.${db.type}.driver" silent="true" />
	<propertycopy name="db.url" from="db.${db.type}.url" silent="true" />
	<propertycopy name="db.username" from="db.${db.type}.username" silent="true" />
	<propertycopy name="db.password" from="db.${db.type}.password" silent="true" />

	<target name="deploy-simple-server-plugins">
		<property name="liferay.home" value="${simple.server.dir}/.." />

		<delete dir="${liferay.home}/data" />
		<delete dir="${liferay.home}/deploy" />

		<exec dir="${lp.plugins.dir}" executable="cmd.exe">
			<arg line="/c svn update" />
		</exec>

		<echo file="${lp.plugins.dir}/build.${user.name}.properties">app.server.dir=${simple.server.dir}
app.server.portal.dir=${simple.server.portal.dir}

plugins.includes=${plugins.includes}</echo>

		<ant dir="${lp.plugins.dir}/${plugin.types}" inheritAll="false">
			<target name="clean" />
			<target name="deploy" />
		</ant>

		<delete dir="${lp.plugins.dir}/dist" />
		<mkdir dir="${lp.plugins.dir}/dist" />
	</target>

	<target name="prepare-common">
		<antcall target="prepare-portal-ext-properties" inheritAll="false" />

		<exec executable="cmd.exe">
			<arg line="/c svn revert portal-web/docroot/WEB-INF/web.xml" />
		</exec>

		<replace
			file="portal-web/docroot/WEB-INF/web.xml"
			token="session-timeout&gt;30&lt;"
			value="session-timeout&gt;2&lt;"
		/>

		<antcall target="clean" />
		<antcall target="start" />
	</target>

	<target name="prepare-mysql-5.0">
		<echo file="test.${user.name}.properties">db.type=mysql-5.0</echo>

		<antcall target="prepare-common" />
	</target>

	<target name="prepare-oracle-10">
		<echo file="test.${user.name}.properties">db.type=oracle-10</echo>

		<antcall target="prepare-common" />
	</target>

	<target name="prepare-portal-ext-properties">
		<echo file="portal-impl/src/portal-ext.properties"><![CDATA[jdbc.default.jndi.name=

jdbc.default.driverClassName=${db.driver}
jdbc.default.url=${db.url}
jdbc.default.username=${db.username}
jdbc.default.password=${db.password}

captcha.max.challenges=0

browser.launcher.url=

mail.session.jndi.name=

axis.servlet.hosts.allowed=

tunnel.servlet.hosts.allowed=]]></echo>
	</target>

	<target name="prepare-tomcat-5.5-mysql-5.0">
		<antcall target="prepare-mysql-5.0" />

		<ant antfile="build-dist.xml" target="build-dist-tomcat-5.5" />
	</target>

	<target name="rebuild-database">
		<if>
			<equals arg1="${skip.rebuild-database}" arg2="$${skip.rebuild-database}" />
			<then>
				<if>
					<equals arg1="${db.type}" arg2="mysql-5.0" />
					<then>
						<antcall target="rebuild-database-mysql-5.0" />
					</then>
					<elseif>
						<equals arg1="${db.type}" arg2="oracle-10" />
						<then>
							<antcall target="rebuild-database-oracle-10" />
						</then>
					</elseif>
				</if>
			</then>
		</if>
	</target>

	<target name="rebuild-database-mysql-5.0">
		<ant dir="sql" target="rebuild-mysql" inheritAll="false" />
	</target>

	<target name="rebuild-database-oracle-10">
		<if>
			<or>
				<equals arg1="${sql.dir}" arg2="$${sql.dir}" />
				<equals arg1="${sql.file}" arg2="$${sql.file}" />
			</or>
			<then>
				<property name="sql.dir" value="sql\create\" />
				<property name="sql.file" value="create-oracle.sql" />
			</then>
		</if>

		<tstamp>
			<format property="tstamp.value" pattern="yyyyMMddkkmmssSSS" />
		</tstamp>

		<property name="temp.dir" value="temp\${db.oracle-10.username}\${tstamp.value}" />

		<exec executable="${plink.executable}">
			<arg line="-pw ${vm.password} ${vm.username}@${db.oracle-10.host} cmd.exe /c mkdir C:\${temp.dir}" />
		</exec>

		<exec executable="${pscp.executable}">
			<arg line="-pw ${vm.password} ${sql.dir}${sql.file} ${vm.username}@${db.oracle-10.host}:\${temp.dir}" />
		</exec>

		<exec executable="${plink.executable}">
			<arg line="-pw ${vm.password} ${vm.username}@${db.oracle-10.host} sqlplus system/password @C:\${temp.dir}\${sql.file} ${db.oracle-10.username} ${db.oracle-10.password}" />
		</exec>

		<exec executable="${plink.executable}">
			<arg line="-pw ${vm.password} ${vm.username}@${db.oracle-10.host} cmd.exe /c rmdir /q /s C:\${temp.dir}" />
		</exec>
	</target>

	<target name="revert-test-properties">
		<exec executable="cmd.exe">
			<arg line="/c svn revert portal-impl/test/test-portal-impl.properties" />
		</exec>

		<exec executable="cmd.exe">
			<arg line="/c svn revert portal-web/test/test-portal-web.properties" />
		</exec>
	</target>

	<target name="prepare-vm-server">
		<ant antfile="build-dist.xml" target="build-dist-tomcat-5.5" />

		<delete dir="dist" />
		<mkdir dir="dist" />

		<ant antfile="build-dist.xml" target="zip-portal-war-2.4" />

		<echo>Copying ${vm.drive}\${vm.host}\${vm.host}.vmdk.${vm.vmdk.suffix} to ${vm.drive}\${vm.host}\${vm.host}.vmdk</echo>

		<exec executable="cmd">
			<arg line="/c copy /y ${vm.drive}\${vm.host}\${vm.host}.vmdk.${vm.vmdk.suffix} ${vm.drive}\${vm.host}\${vm.host}.vmdk" />
		</exec>

		<exec dir="${vm.drive}/${vm.host}" executable="${vmware-cmd.executable}">
			<arg line="${vm.drive}\${vm.host}\${vm.host}.vmx start" />
		</exec>

		<sleep seconds="30" />

		<echo file="hosts">127.0.0.1	localhost
127.0.0.1	liferay-b711dd9
127.0.0.1	www.able.com
127.0.0.1	www.baker.com
127.0.0.1	www.charlie.com
127.0.0.1	www.dog.com
127.0.0.1	www.easy.com
127.0.0.1	www.fox.com</echo>

		<exec executable="${pscp.executable}">
			<arg line="-pw ${vm.password} hosts dist\liferay-portal-${lp.version}.war tunnel-web\tunnel-web.war ${vm.username}@${vm.host}:/" />
		</exec>

		<delete file="hosts" />

		<exec executable="${plink.executable}">
			<arg line="-pw ${vm.password} ${vm.username}@${vm.host} cmd.exe /c move /y C:\hosts C:\WINDOWS\system32\drivers\etc\hosts" />
		</exec>

		<ant antfile="build-dist.xml" target="zip-portal-dependencies" />
	</target>

	<target name="run-jboss-tomcat-5.0">
		<antcall target="run-simple-server">
			<param name="simple.server.dir" value="${app.server.parent.dir}/jboss-tomcat-5.0.0" />
			<param name="simple.server.bin.dir" value="${app.server.parent.dir}/jboss-tomcat-5.0.0/bin" />
			<param name="simple.server.deploy.dir" value="${app.server.parent.dir}/jboss-tomcat-5.0.0/server/default/deploy" />
			<param name="simple.server.portal.dir" value="${app.server.parent.dir}/jboss-tomcat-5.0.0/server/default/deploy/ROOT.war" />
			<param name="simple.server.start.executable" value="run${file.suffix.bat}" />
			<param name="simple.server.stop.executable" value="shutdown${file.suffix.bat}" />
			<param name="simple.server.stop.executable.arg.line" value="-S" />
		</antcall>
	</target>

	<target name="run-selenium-test">
		<if>
			<equals arg1="${test.class}" arg2="PortalWebTestSuite" />
			<then>
				<ant dir="portal-impl" target="test-class" inheritAll="false">
					<property name="class" value="ServiceHttpTestSuite" />
				</ant>

				<ant dir="portal-impl" target="test-class" inheritAll="false">
					<property name="class" value="ServiceSoapTestSuite" />
				</ant>
			</then>
		</if>

		<ant dir="portal-web" target="test-class" inheritAll="false">
			<property name="class" value="${test.class}" />
		</ant>
	</target>

	<target name="run-simple-server">
		<antcall target="rebuild-database" inheritAll="false" />

		<delete includeemptydirs="true" failonerror="false">
			<fileset
				dir="${simple.server.deploy.dir}"
				includes="*-portlet/**,*-theme/**"
			/>
		</delete>

		<if>
			<not>
				<equals arg1="${portlet.plugins.includes}" arg2="$${portlet.plugins.includes}" />
			</not>
			<then>
				<antcall target="deploy-simple-server-plugins">
					<param name="plugin.types" value="portlets" />
					<param name="plugins.includes" value="${portlet.plugins.includes}" />
				</antcall>
			</then>
		</if>

		<if>
			<not>
				<equals arg1="${theme.plugins.includes}" arg2="$${theme.plugins.includes}" />
			</not>
			<then>
				<antcall target="deploy-simple-server-plugins">
					<param name="plugin.types" value="themes" />
					<param name="plugins.includes" value="${theme.plugins.includes}" />
				</antcall>
			</then>
		</if>

		<parallel>
			<exec dir="${simple.server.bin.dir}" executable="${simple.server.start.executable}" resolveexecutable="true">
				<arg line="${simple.server.start.executable.arg.line}" />
			</exec>

			<sequential>
				<waitfor>
					<http url="http://localhost:8080" />
				</waitfor>

				<sleep seconds="30" />

				<antcall target="run-selenium-test" />

				<exec dir="${simple.server.bin.dir}" executable="${simple.server.stop.executable}" resolveexecutable="true">
					<arg line="${simple.server.stop.executable.arg.line}" />
				</exec>
			</sequential>
		</parallel>
	</target>

	<target name="run-tomcat-5.5">
		<antcall target="run-simple-server">
			<param name="simple.server.dir" value="${app.server.tomcat.dir}" />
			<param name="simple.server.bin.dir" value="${app.server.tomcat.bin.dir}" />
			<param name="simple.server.deploy.dir" value="${app.server.tomcat.deploy.dir}" />
			<param name="simple.server.portal.dir" value="${app.server.tomcat.portal.dir}" />
			<param name="simple.server.start.executable" value="catalina${file.suffix.bat}" />
			<param name="simple.server.start.executable.arg.line" value="run" />
			<param name="simple.server.stop.executable" value="shutdown${file.suffix.bat}" />
		</antcall>
	</target>

	<target name="run-weblogic-10.3">
		<antcall target="rebuild-database" inheritAll="false" />

		<parallel>
			<exec executable="${plink.executable}">
				<arg line="-pw ${vm.password} ${vm.username}@${vm.host} cmd.exe /c C:\bea\user_projects\domains\base_domain\bin\startWebLogic.cmd" />
			</exec>

			<sequential>
				<waitfor>
					<http url="http://${vm.host}:7001/console" />
				</waitfor>

				<antcall target="run-selenium-test" />

				<exec executable="${plink.executable}">
					<arg line="-pw ${vm.password} ${vm.username}@${vm.host} cmd.exe /c C:\bea\user_projects\domains\base_domain\bin\stopWebLogic.cmd" />
				</exec>
			</sequential>
		</parallel>
	</target>

	<target name="run-websphere-6.0">
		<antcall target="rebuild-database" inheritAll="false" />

		<exec executable="${plink.executable}">
			<arg line="-pw ${vm.password} ${vm.username}@${vm.host} cmd.exe /c C:\Progra~1\IBM\WebSphere\AppServer\profiles\AppSrv01\bin\startServer.bat server1" />
		</exec>

		<antcall target="run-selenium-test" />

		<exec executable="${plink.executable}">
			<arg line="-pw ${vm.password} ${vm.username}@${vm.host} cmd.exe /c C:\Progra~1\IBM\WebSphere\AppServer\profiles\AppSrv01\bin\stopServer.bat server1" />
		</exec>
	</target>

	<target name="start-selenium">
		<java jar="lib/development/selenium-server.jar" fork="true" spawn="true">
			<arg line="-port 14444 -singleWindow" />
		</java>
	</target>

	<target name="stop-selenium">
		<antelope:post to="http://localhost:14444/selenium-server/driver/?cmd=shutDown" wantresponse="true" />
	</target>

	<target name="test">
		<antcall target="prepare-mysql-5.0" />

		<antcall target="rebuild-database" inheritAll="false" />

		<antcall target="revert-test-properties" />

		<ant dir="portal-impl" target="test-class" inheritAll="false">
			<property name="class" value="ServiceTestSuite" />
		</ant>

		<ant dir="portal-impl" target="test-class" inheritAll="false">
			<property name="class" value="PersistenceTestSuite" />
		</ant>

		<ant dir="portal-impl" target="test-class" inheritAll="false">
			<property name="class" value="MiscTestSuite" />
		</ant>

		<ant dir="portal-kernel" target="test" inheritAll="false" />

		<ant dir="util-java" target="test" inheritAll="false" />
	</target>

	<target name="test-database">

		<!--
		Manually run "prepare-tomcat-5.5-mysql-5.0" before running any
		test-database-* tasks.
		-->

		<antcall target="test-database-oracle-10" />
	</target>

	<target name="test-database-oracle-10">
		<antcall target="test-database-oracle-10-latest" />
		<antcall target="test-database-oracle-10-5.1.0" />
		<antcall target="test-database-oracle-10-5.1.1" />
		<antcall target="test-database-oracle-10-5.1.2" />
	</target>

	<target name="test-database-oracle-10-5.1.0">
		<antcall target="test-database-oracle-10-common">
			<param name="sql.version" value="5.1.0" />
		</antcall>
	</target>

	<target name="test-database-oracle-10-5.1.1">
		<antcall target="test-database-oracle-10-common">
			<param name="sql.version" value="5.1.1" />
		</antcall>
	</target>

	<target name="test-database-oracle-10-5.1.2">
		<antcall target="test-database-oracle-10-common">
			<param name="sql.version" value="5.1.2" />
		</antcall>
	</target>

	<target name="test-database-oracle-10-common">
		<echo file="test.${user.name}.properties">db.type=oracle-10</echo>

		<antcall target="prepare-portal-ext-properties" inheritAll="false" />

		<ant dir="portal-impl" target="deploy-properties" inheritAll="false" />

		<if>
			<not>
				<equals arg1="${sql.version}" arg2="$${sql.version}" />
			</not>
			<then>
				<property name="sql.dir" value="sql\legacy\${sql.version}\create\" />
				<property name="sql.file" value="create-oracle.sql" />
			</then>
		</if>

		<antcall target="rebuild-database" inheritAll="false">
			<param name="sql.dir" value="${sql.dir}" />
			<param name="sql.file" value="${sql.file}" />
		</antcall>

		<antcall target="start-selenium" />

		<antcall target="run-tomcat-5.5">
			<param name="skip.rebuild-database" value="true" />
			<param name="test.class" value="SmokeTestSuite" />
		</antcall>

		<antcall target="stop-selenium" />
	</target>

	<target name="test-database-oracle-10-latest">
		<echo file="create-${db.oracle-10.username}.sql"><![CDATA[drop user &1 cascade;
create user &1 identified by &2;
grant connect,resource to &1;
exit;]]></echo>

		<antcall target="test-database-oracle-10-common">
			<param name="sql.dir" value="" />
			<param name="sql.file" value="create-${db.oracle-10.username}.sql" />
		</antcall>

		<delete file="create-${db.oracle-10.username}.sql" />
	</target>

	<target name="test-jboss-tomcat-5.0-common">
		<ant antfile="build-dist.xml" target="build-dist-jboss-tomcat-5.0" />

		<antcall target="revert-test-properties" />

		<antcall target="start-selenium" />

		<antcall target="run-jboss-tomcat-5.0">
			<param name="test.class" value="PortalWebTestSuite" />
		</antcall>

		<antcall target="stop-selenium" />
	</target>

	<target name="test-jboss-tomcat-5.0-mysql-5.0">
		<antcall target="prepare-mysql-5.0" />

		<antcall target="test-jboss-tomcat-5.0-common" />
	</target>

	<target name="test-jboss-tomcat-5.0-oracle-10">
		<antcall target="prepare-oracle-10" />

		<antcall target="test-jboss-tomcat-5.0-common" />
	</target>

	<target name="test-tck">
		<antcall target="prepare-portal-ext-properties" />

		<echo file="portal-impl/src/portal-ext.properties" append="true">

tck.url=true</echo>

		<exec executable="cmd.exe">
			<arg line="/c svn revert portal-web/docroot/WEB-INF/web.xml" />
		</exec>

		<antcall target="clean" />
		<antcall target="start" />

		<ant antfile="build-dist.xml" target="build-dist-tomcat-5.5" />

		<delete dir="tools/tck" />

		<unzip src="tools/portlet-tck070508.zip" dest="tools/tck" />

		<replace file="tools/tck/bin/ts.jte">
			<replacefilter token="http://localhost:8080/pluto/tck" value="http://localhost:8080/c/portal/tck" />
		</replace>

		<echo file="tools/tck/bin/build.properties" append="true">

work.dir=${basedir.unix}/tools/tck/work</echo>

		<property name="liferay.home" value="${app.server.dir}/.." />

		<delete dir="${liferay.home}/data" />
		<delete dir="${liferay.home}/deploy" />

		<copy todir="${liferay.home}/deploy" flatten="true">
			<fileset
				dir="tools/tck"
				includes="**/*.war"
			/>
		</copy>

		<antcall target="rebuild-database" inheritAll="false" />

		<parallel>
			<exec dir="${app.server.tomcat.bin.dir}" executable="catalina${file.suffix.bat}" resolveexecutable="true">
				<arg line="run" />
			</exec>

			<sequential>
				<waitfor>
					<http url="http://localhost:8080" />
				</waitfor>

				<sleep seconds="60" />

				<exec dir="tools/tck/src/com" executable="${basedir}/tools/tck/bin/tsant.bat">
					<arg line="runclient" />
					<env key="TS_HOME" value="${basedir}\tools\tck" />
				</exec>

				<exec dir="${app.server.tomcat.bin.dir}" executable="shutdown${file.suffix.bat}" resolveexecutable="true" />
			</sequential>
		</parallel>

		<mkdir dir="portal-impl/test-results" />

		<java
			classname="com.liferay.portal.tools.TCKtoJUnitConverter"
			classpathref="project.classpath"
			fork="true"
			newenvironment="true"
		>
			<jvmarg value="-Dexternal-properties=com/liferay/portal/tools/dependencies/portal-tools.properties" />
			<arg value="tools/tck/work/jtData/harness.trace" />
			<arg value="portal-impl/test-results" />
		</java>
	</target>

	<target name="test-themes">
		<antcall target="prepare-tomcat-5.5-mysql-5.0" />

		<exec dir="${lp.plugins.dir}" executable="cmd.exe">
			<arg line="/c svn update" />
		</exec>

		<antcall target="revert-test-properties" />

		<antcall target="start-selenium" />

		<antcall target="run-tomcat-5.5">
			<param name="test.class" value="ThemesTestSuite" />
			<param name="theme.plugins.includes" value="08-gulona-theme,liferay-jedi-theme" />
		</antcall>

		<antcall target="stop-selenium" />
	</target>

	<target name="test-tomcat-5.5-common">
		<ant antfile="build-dist.xml" target="build-dist-tomcat-5.5" />

		<antcall target="revert-test-properties" />

		<antcall target="start-selenium" />

		<antcall target="run-tomcat-5.5">
			<param name="test.class" value="PortalWebTestSuite" />
		</antcall>

		<antcall target="run-tomcat-5.5">
			<param name="test.class" value="ControlPanelTestSuite" />
		</antcall>

		<antcall target="run-tomcat-5.5">
			<param name="test.class" value="PermissionsTestSuite" />
		</antcall>

		<antcall target="run-tomcat-5.5">
			<param name="test.class" value="Plugins1TestSuite" />
			<param name="portlet.plugins.includes" value="alfresco-content-portlet,analog-clock-portlet,chat-portlet,flash-portlet,google-adsense-portlet,google-gadget-portlet,google-maps-portlet,google-search-portlet,ip-geocoder-portlet,mail-portlet,release-tools-portlet,ruby-console-portlet,sample-dao-portlet,sample-groovy-portlet,sample-hibernate-portlet,sample-icefaces-ipc-ajax-push-portlet,sample-icefaces-jsf-1.1-myfaces-jsp-portlet,sample-icefaces-jsf-1.1-sun-facelets-portlet,sample-icefaces-jsf-1.1-sun-jsp-portlet,sample-icefaces-jsf-1.2-sun-facelets-portlet,sample-javascript-portlet,sample-jsf-1.1-myfaces-facelets-portlet,sample-jsf-1.1-myfaces-jsp-portlet,sample-jsf-1.1-sun-facelets-portlet,sample-jsf-1.1-sun-jsp-portlet,sample-jsf-1.2-sun-facelets-portlet,sample-jsf-1.2-sun-jsp-portlet,sample-json-portlet,sample-jsp-portlet,sample-lar-portlet,sample-laszlo-portlet" />
		</antcall>

		<antcall target="run-tomcat-5.5">
			<param name="test.class" value="Plugins2TestSuite" />
			<param name="portlet.plugins.includes" value="sample-localized-portlet,sample-orbeon-forms-portlet,sample-permissions-portlet,sample-php-portlet,sample-portal-client-portlet,sample-portal-service-portlet,sample-python-portlet,sample-ruby-portlet,sample-search-container-portlet,sample-service-builder-portlet,sample-sign-in-portlet,sample-spring-portlet,sample-struts-liferay-portlet,sample-struts-portlet,sample-tapestry-portlet,sample-test-dependency-able-portlet,sample-test-dependency-baker-portlet,sample-test-dependency-charlie-portlet,sample-test-dependency-dog-portlet,sample-test-dependency-easy-portlet,sample-test-dependency-fox-portlet,sample-test-hook-portlet,sample-test-portlet,sample-ui-taglibs-portlet,sample-wap-portlet,stocks-portlet,sun-bookmark-portlet,sun-elluminate-portlet,sun-flickr-portlet,sun-iframe-portlet,sun-mashup-portlet,sun-notepad-portlet,sun-photoshow-ajax-portlet,sun-privacy-guard-portlet,sun-rss-portlet,sun-showtime-portlet,sun-tour-ipc-portlet,sun-video-portlet,sun-weather-portlet,twitter-portlet,weather-portlet,web-form-portlet,westminster-catechism-portlet,widget-consumer-portlet,wiki-navigation-portlet,wol-portlet" />
		</antcall>

		<antcall target="run-tomcat-5.5">
			<param name="test.class" value="StagingTestSuite" />
		</antcall>

		<antcall target="stop-selenium" />
	</target>

	<target name="test-tomcat-5.5-mysql-5.0">
		<antcall target="prepare-mysql-5.0" />

		<antcall target="test-tomcat-5.5-common" />
	</target>

	<target name="test-tomcat-5.5-oracle-10">
		<antcall target="prepare-oracle-10" />

		<antcall target="test-tomcat-5.5-common" />
	</target>

	<target name="test-weblogic-10.3-common">
		<antcall target="prepare-vm-server">
			<param name="vm.vmdk.suffix" value="weblogic-10.3" />
		</antcall>

		<tstamp>
			<format property="tstamp.value" pattern="yyyyMMddkkmmssSSS" />
		</tstamp>

		<unzip src="dist/liferay-portal-dependencies-${lp.version}.zip" dest="${tstamp.value}">
			<mapper type="flatten" />
		</unzip>

		<exec executable="${pscp.executable}">
			<arg line="-pw ${vm.password} lib\development\mysql.jar ${tstamp.value}\*.jar ${vm.username}@${vm.host}:/bea/user_projects/domains/base_domain/lib" />
		</exec>

		<delete dir="${tstamp.value}" />

		<exec executable="${plink.executable}">
			<arg line="-pw ${vm.password} ${vm.username}@${vm.host} cmd.exe /c mkdir C:\bea\jdk160_05\jre\lib\endorsed" />
		</exec>

		<exec executable="${pscp.executable}">
			<arg line="-pw ${vm.password} lib\portal\rhino.jar lib\portal\serializer.jar lib\portal\xalan.jar ${vm.username}@${vm.host}:/bea/jdk160_05/jre/lib/endorsed" />
		</exec>

		<exec executable="${plink.executable}">
			<arg line="-pw ${vm.password} ${vm.username}@${vm.host} cmd.exe /c mkdir C:\bea\jrockit_160_05\jre\lib\endorsed" />
		</exec>

		<exec executable="${pscp.executable}">
			<arg line="-pw ${vm.password} lib\portal\rhino.jar lib\portal\serializer.jar lib\portal\xalan.jar ${vm.username}@${vm.host}:/bea/jrockit_160_05/jre/lib/endorsed" />
		</exec>

		<exec executable="${pscp.executable}">
			<arg line="-pw ${vm.password} ${vm.username}@${vm.host}:/bea/user_projects/domains/base_domain/bin/setDomainEnv.cmd setDomainEnv.cmd" />
		</exec>

		<replace file="setDomainEnv.cmd">
			<replacefilter token="set MEM_ARGS=-Xms256m -Xmx512m" value="set MEM_ARGS=-Xms256m -Xmx1024m" />
			<replacefilter token="set MEM_MAX_PERM_SIZE=-XX:MaxPermSize=128m" value="set MEM_MAX_PERM_SIZE=-XX:MaxPermSize=256m" />
		</replace>

		<exec executable="${pscp.executable}">
			<arg line="-pw ${vm.password} setDomainEnv.cmd ${vm.username}@${vm.host}:/bea/user_projects/domains/base_domain/bin/setDomainEnv.cmd" />
		</exec>

		<delete file="setDomainEnv.cmd" />

		<parallel>
			<exec executable="${plink.executable}">
				<arg line="-pw ${vm.password} ${vm.username}@${vm.host} cmd.exe /c C:\bea\user_projects\domains\base_domain\bin\startWebLogic.cmd" />
			</exec>

			<sequential>
				<waitfor>
					<http url="http://${vm.host}:7001/console" />
				</waitfor>

				<exec executable="${plink.executable}">
					<arg line="-pw ${vm.password} ${vm.username}@${vm.host} C:\bea\jdk160_05\bin\java.exe -cp C:\bea\wlserver_10.3\server\lib\weblogic.jar -Xmx256m weblogic.Deployer -adminurl t3://localhost:7001 -user system -password password -deploy -upload C:\liferay-portal-${lp.version}.war" />
				</exec>

				<exec executable="${plink.executable}">
					<arg line="-pw ${vm.password} ${vm.username}@${vm.host} C:\bea\jdk160_05\bin\java.exe -cp C:\bea\wlserver_10.3\server\lib\weblogic.jar -Xmx256m weblogic.Deployer -adminurl t3://localhost:7001 -user system -password password -deploy -upload C:\tunnel-web.war" />
				</exec>

				<exec executable="${plink.executable}">
					<arg line="-pw ${vm.password} ${vm.username}@${vm.host} cmd.exe /c C:\bea\user_projects\domains\base_domain\bin\stopWebLogic.cmd" />
				</exec>
			</sequential>
		</parallel>

		<antcall target="revert-test-properties" />

		<replace
			file="portal-impl/test/test-portal-impl.properties"
			token="localhost:8080"
			value="${vm.host}:7001"
		/>

		<replace
			file="portal-web/test/test-portal-web.properties"
			token="localhost:8080"
			value="${vm.host}:7001"
		/>

		<antcall target="start-selenium" />

		<antcall target="run-weblogic-10.3">
			<param name="test.class" value="PortalWebTestSuite" />
		</antcall>

		<antcall target="stop-selenium" />

		<exec dir="${vm.drive}/${vm.host}" executable="${vmware-cmd.executable}">
			<arg line="${vm.drive}\${vm.host}\${vm.host}.vmx stop hard" />
		</exec>
	</target>

	<target name="test-weblogic-10.3-mysql-5.0">
		<antcall target="prepare-mysql-5.0" />

		<antcall target="test-weblogic-10.3-common" />
	</target>

	<target name="test-weblogic-10.3-oracle-10">
		<antcall target="prepare-oracle-10" />

		<antcall target="test-weblogic-10.3-common" />
	</target>

	<target name="test-websphere-6.1-common">
		<antcall target="prepare-vm-server">
			<param name="vm.vmdk.suffix" value="websphere-6.1.0.21" />
		</antcall>

		<tstamp>
			<format property="tstamp.value" pattern="yyyyMMddkkmmssSSS" />
		</tstamp>

		<unzip src="dist/liferay-portal-dependencies-${lp.version}.zip" dest="${tstamp.value}">
			<mapper type="flatten" />
		</unzip>

		<exec executable="${pscp.executable}">
			<arg line="-pw ${vm.password} lib\development\mysql.jar ${tstamp.value}\*.jar ${vm.username}@${vm.host}:/Progra~1/IBM/WebSphere/AppServer/lib/ext" />
		</exec>

		<delete dir="${tstamp.value}" />

		<exec executable="${plink.executable}">
			<arg line="-pw ${vm.password} ${vm.username}@${vm.host} cmd.exe /c move C:\Progra~1\IBM\WebSphere\AppServer\lib\ext\portlet.jar C:\Progra~1\IBM\WebSphere\AppServer\java\jre\lib\ext" />
		</exec>

		<exec executable="${plink.executable}">
			<arg line="-pw ${vm.password} ${vm.username}@${vm.host} cmd.exe /c C:\Progra~1\IBM\WebSphere\AppServer\profiles\AppSrv01\bin\startServer.bat server1" />
		</exec>

		<echo file="wsadmin.py">print AdminApp.list()

print AdminApp.uninstall('DefaultApplication')

print AdminConfig.save()

print AdminApp.install('C:/liferay-portal-${lp.version}.war', '[-appname liferay-portal -contextroot /]')

print AdminConfig.save()

print AdminApp.list()

print AdminApp.install('C:/tunnel-web.war', '[-appname liferay-tunnel-web -contextroot /tunnel-web]')

print AdminConfig.save()

print AdminApp.list()

applicationManager = AdminControl.queryNames('type=ApplicationManager,process=server1,*')

print applicationManager

print AdminControl.invoke(applicationManager, 'startApplication', 'liferay-portal')
print AdminControl.invoke(applicationManager, 'startApplication', 'liferay-tunnel-web')</echo>

		<exec executable="${pscp.executable}">
			<arg line="-pw ${vm.password} wsadmin.py ${vm.username}@${vm.host}:/" />
		</exec>

		<delete file="wsadmin.py" />

		<exec executable="${plink.executable}">
			<arg line="-pw ${vm.password} ${vm.username}@${vm.host} cmd.exe /c C:\Progra~1\IBM\WebSphere\AppServer\bin\wsadmin.bat -f C:\wsadmin.py" />
		</exec>

		<exec executable="${plink.executable}">
			<arg line="-pw ${vm.password} ${vm.username}@${vm.host} cmd.exe /c C:\Progra~1\IBM\WebSphere\AppServer\profiles\AppSrv01\bin\stopServer.bat server1" />
		</exec>

		<antcall target="revert-test-properties" />

		<replace
			file="portal-impl/test/test-portal-impl.properties"
			token="localhost:8080"
			value="${vm.host}:9080"
		/>

		<replace
			file="portal-web/test/test-portal-web.properties"
			token="localhost:8080"
			value="${vm.host}:9080"
		/>

		<antcall target="start-selenium" />

		<antcall target="run-websphere-6.0">
			<param name="test.class" value="PortalWebTestSuite" />
		</antcall>

		<antcall target="stop-selenium" />

		<exec dir="${vm.drive}/${vm.host}" executable="${vmware-cmd.executable}">
			<arg line="${vm.drive}\${vm.host}\${vm.host}.vmx stop hard" />
		</exec>
	</target>

	<target name="test-websphere-6.1-mysql-5.0">
		<antcall target="prepare-mysql-5.0" />

		<antcall target="test-websphere-6.1-common" />
	</target>

	<target name="test-websphere-6.1-oracle-10">
		<antcall target="prepare-oracle-10" />

		<antcall target="test-websphere-6.1-common" />
	</target>
</project>