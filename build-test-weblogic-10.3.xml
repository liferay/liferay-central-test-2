<?xml version="1.0"?>

<project name="portal-test-weblogic-10.3" basedir="." default="test" xmlns:antelope="antlib:ise.antelope.tasks">
	<import file="build-test.xml" />

	<target name="run-selenium-weblogic-10.3">
		<tstamp>
			<format property="tstamp.value" pattern="yyyyMMddkkmmssSSS" />
		</tstamp>

		<echo file="app.server.${user.name}.properties">app.server.type=weblogic</echo>

		<if>
			<not>
				<isset property="build.app.server" />
			</not>
			<then>
				<ant antfile="build-dist.xml" target="unzip-weblogic" />
				<ant target="all" />
			</then>
		</if>

		<ant antfile="build-dist.xml" target="zip-portal-dependencies" />

		<unzip src="dist/liferay-portal-dependencies-${lp.version}.zip" dest="${tstamp.value}">
			<mapper type="flatten" />
		</unzip>

		<copy todir="${tstamp.value}">
			<fileset
				dir="lib/development"
				includes="hsql.jar,jtds.jar,mysql.jar,postgresql.jar"
			/>
			<fileset
				dir="lib/portal"
				includes="serializer.jar,xalan.jar"
			/>
		</copy>

		<if>
			<isset property="jdbc.drivers.optional.dir" />
			<then>
				<copy todir="${tstamp.value}">
					<fileset
						dir="${jdbc.drivers.optional.dir}"
						includes="*.jar"
					/>
				</copy>
			</then>
		</if>

		<if>
			<isset property="hook.plugins.includes" />
			<then>
				<ant antfile="build-test-plugins.xml" target="deploy-weblogic-10.3-plugins">
					<property name="plugin.types" value="hooks" />
					<property name="plugins.deployed" value="${plugins.deployed}" />
					<property name="plugins.includes" value="${hook.plugins.includes}" />
				</ant>

				<property name="plugins.deployed" value="true" />
			</then>
		</if>

		<if>
			<isset property="plugins.version.includes" />
			<then>
				<ant antfile="build-test-plugins.xml" target="deploy-versioned-weblogic-10.3-plugins">
					<property name="plugins.includes" value="${plugins.version.includes}" />
				</ant>
			</then>
		</if>

		<if>
			<isset property="portlet.plugins.includes" />
			<then>
				<ant antfile="build-test-plugins.xml" target="deploy-weblogic-10.3-plugins">
					<property name="plugin.types" value="portlets" />
					<property name="plugins.deployed" value="${plugins.deployed}" />
					<property name="plugins.includes" value="${portlet.plugins.includes}" />
				</ant>

				<property name="plugins.deployed" value="true" />
			</then>
		</if>

		<if>
			<isset property="portlet.plugins.upgrade.includes" />
			<then>
				<ant antfile="build-test-plugins.xml" target="deploy-upgrade-weblogic-10.3-plugins">
					<property name="plugin.types" value="portlets" />
					<property name="plugins.includes" value="${portlet.plugins.upgrade.includes}" />
				</ant>
			</then>
		</if>

		<if>
			<isset property="theme.plugins.includes" />
			<then>
				<ant antfile="build-test-plugins.xml" target="deploy-weblogic-10.3-plugins">
					<property name="plugin.types" value="themes" />
					<property name="plugins.deployed" value="${plugins.deployed}" />
					<property name="plugins.includes" value="${theme.plugins.includes}" />
				</ant>

				<property name="plugins.deployed" value="true" />
			</then>
		</if>

		<if>
			<isset property="web.plugins.includes" />
			<then>
				<ant antfile="build-test-plugins.xml" target="deploy-weblogic-10.3-plugins">
					<property name="plugin.types" value="webs" />
					<property name="plugins.deployed" value="${plugins.deployed}" />
					<property name="plugins.includes" value="${web.plugins.includes}" />
				</ant>

				<property name="plugins.deployed" value="true" />
			</then>
		</if>

		<antcall target="revert-test-properties" />

		<antcall target="prepare-selenium" />

		<antcall target="start-selenium" />

		<antcall target="clean-up-logs" />

		<record action="start" name="log" />

		<antcall target="run-weblogic-10.3">
			<param name="test.class" value="${test.name}" />
		</antcall>

		<record action="stop" name="log" />

		<antcall target="evaluate-logs" />

		<delete dir="${tstamp.value}" />

		<antcall target="stop-selenium" />
	</target>

	<target name="run-weblogic-10.3">
		<antcall target="run-simple-server">
			<param name="simple.server.dir" value="${app.server.weblogic.dir}" />
			<param name="simple.server.bin.dir" value="${app.server.weblogic.bin.dir}" />
			<param name="simple.server.deploy.dir" value="${app.server.weblogic.deploy.dir}" />
			<param name="simple.server.lib.global.dir" value="${app.server.weblogic.lib.global.dir}" />
			<param name="simple.server.portal.dir" value="${app.server.weblogic.portal.dir}" />
			<param name="simple.server.start.executable" value="../run.bat" />
			<param name="simple.server.start.executable.arg.line" value="" />
			<param name="simple.server.stop.executable" value="stopWebLogic.cmd" />
			<param name="simple.server.stop.executable.arg.line" value="" />
		</antcall>

		<record action="stop" name="log" />

		<antcall target="evaluate-logs" />
	</target>
</project>