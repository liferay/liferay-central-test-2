<?xml version="1.0"?>

<project name="portal" basedir="." default="compile" xmlns:antelope="antlib:ise.antelope.tasks">
	<property name="project.dir" value="." />

	<import file="build-common.xml" />

	<target name="all">
		<antcall target="clean" />
		<antcall target="start" />
		<antcall target="deploy" />
	</target>

	<target name="start">
		<antcall target="compile" />

		<ant dir="util-taglib" target="jar" inheritAll="false" />

		<ant dir="sql" target="build-db" inheritAll="false" />
		<ant dir="sql" target="rebuild-hypersonic" inheritAll="false" />

		<ant dir="portal-impl" target="build-reverendfun" inheritAll="false" />
  		<ant dir="portal-impl" target="build-themes" inheritAll="false" />

		<antcall target="jar" />

		<antcall target="print-current-time" />
	</target>

	<target name="clean">
		<ant dir="classes" target="clean" inheritAll="false" />

		<ant dir="portal-kernel" target="clean" inheritAll="false" />
		<ant dir="portal-service" target="clean" inheritAll="false" />

		<ant dir="util-bridges" target="clean" inheritAll="false" />
		<ant dir="util-java" target="clean" inheritAll="false" />
		<ant dir="util-taglib" target="clean" inheritAll="false" />

		<ant dir="portal-impl" target="clean" inheritAll="false" />

		<ant dir="portal-web" target="clean" inheritAll="false" />
		<ant dir="tunnel-web" target="clean" inheritAll="false" />

		<delete>
			<fileset dir="." includes="*.ear,*.jar,*.war,*.zip" />
		</delete>

		<delete includeemptydirs="true" failonerror="false">
			<fileset
				dir="${app.server.bin.dir}"
				includes="*.log*"
			/>
		</delete>

		<delete failonerror="false">
			<fileset
				dir="${app.server.dir}/../data/hsql"
				includes="${database.name}.*"
			/>
		</delete>

		<if>
			<or>
				<equals arg1="${app.server.type}" arg2="jonas-jetty" />
				<equals arg1="${app.server.type}" arg2="jonas-tomcat" />
			</or>
			<then>
				<delete includeemptydirs="true" failonerror="false">
					<fileset
						dir="${app.server.dir}"
						includes="demoserver/**,examples/**,"
					/>
					<fileset
						dir="${app.server.dir}/apps"
						includes="*.ear,autoload/*.ear"
					/>
					<fileset
						dir="${app.server.dir}/conf"
						includes="db2.properties,FirebirdSQL.properties,HSQL1.properties,InstantDB1.properties,InterBase1.properties,MailMimePartDS1.properties,MailSession1.properties,McKoi1.properties,MySQL.properties,Oracle1.properties,PostgreSQL1.properties,spy.properties,Sybase1.properties"
					/>
					<fileset
						dir="${app.server.dir}/ejbjars"
						includes="*.jar,autoload/*.jar"
					/>
					<fileset
						dir="${app.server.dir}/webapps"
						includes="*.war,autoload/*.war,autoload/jonas-doc-en/**,autoload/jonas-javadoc/**"
					/>
				</delete>
			</then>
			<elseif>
				<equals arg1="${app.server.type}" arg2="tomcat" />
				<then>
					<ant dir="support-tomcat" target="clean" inheritAll="false" />

					<if>
						<equals arg1="${app.server.version}" arg2="5.5" />
						<then>
							<delete includeemptydirs="true" failonerror="false">
								<fileset
									dir="${app.server.deploy.dir}"
									includes="balancer/**,jsp-examples/**,servlets-examples/**,tomcat-docs/**,webdav/**"
								/>
								<fileset
									dir="${app.server.dir}/conf/Catalina/localhost"
									includes="host-manager.xml,manager.xml"
								/>
								<fileset
									dir="${app.server.dir}/server/webapps"
									includes="host-manager/**,manager/**"
								/>
							</delete>
						</then>
					</if>

					<if>
						<equals arg1="${app.server.version}" arg2="6.0" />
						<then>
							<delete includeemptydirs="true" failonerror="false">
								<fileset
									dir="${app.server.deploy.dir}"
									includes="docs/**,examples/**,host-manager/**,manager/**"
								/>
							</delete>
						</then>
					</if>
				</then>
			</elseif>
		</if>

		<delete failonerror="false">
			<fileset
				dir="${app.server.classes.portal.dir}"
				includes="portal-*.properties,system-*.properties"
			/>
		</delete>

		<delete includeemptydirs="true" failonerror="false">
			<fileset
				dir="${app.server.deploy.dir}"
				includes="*-ext/**,*-hook/**,*-layouttpl/**,*-portlet/**,*-theme/**,*-web/**"
			/>
		</delete>

		<delete failonerror="false">
			<fileset
				dir="${app.server.lib.global.dir}"
				excludes="${jdbc.drivers}"
			/>
		</delete>

		<delete failonerror="false">
			<fileset
				dir="${app.server.lib.portal.dir}"
				excludes="${jdbc.drivers}"
			/>
		</delete>

		<if>
			<equals arg1="${clean.log.dir}" arg2="true" />
			<then>
				<delete dir="${app.server.log.dir}" />
			</then>
		</if>

		<if>
			<not>
				<and>
					<equals arg1="${app.server.type}" arg2="tomcat" />
					<antelope:endswith string="${app.server.portal.dir}" with="/portal-web/docroot" />
				</and>
			</not>
			<then>
				<delete dir="${app.server.portal.dir}" />
				<delete file="${app.server.portal.dir}" />
			</then>
		</if>

		<if>
			<equals arg1="${clean.temp.dir}" arg2="true" />
			<then>
				<delete dir="${app.server.temp.dir}" />
			</then>
		</if>

		<if>
			<equals arg1="${clean.work.dir}" arg2="true" />
			<then>
				<delete dir="${app.server.work.dir}" />
			</then>
		</if>

		<antcall target="print-current-time" />
	</target>

	<target name="compile">
		<ant dir="portal-kernel" target="compile" inheritAll="false" />
		<ant dir="portal-service" target="compile" inheritAll="false" />

		<ant dir="util-java" target="compile" inheritAll="false" />
		<ant dir="util-bridges" target="compile" inheritAll="false" />

		<ant dir="portal-impl" target="compile" inheritAll="false" />
	</target>

	<target name="jar">
		<ant dir="portal-kernel" target="jar" inheritAll="false" />
		<ant dir="portal-service" target="jar" inheritAll="false" />

		<ant dir="util-bridges" target="jar" inheritAll="false" />
		<ant dir="util-java" target="jar" inheritAll="false" />
		<ant dir="util-taglib" target="jar" inheritAll="false" />

		<ant dir="portal-impl" target="jar" inheritAll="false" />

		<ant dir="portal-web" target="war" inheritAll="false" />
		<ant dir="tunnel-web" target="war" inheritAll="false" />

		<ant dir="support-tomcat" target="jar" inheritAll="false" />
	</target>

	<target name="dtddoc">
		<taskdef classname="DTDDoc.DTDDocTask" classpathref="lib.classpath" name="DTDDoc" />

		<antelope:stringutil string="${lp.version}" property="lp.version.dtd">
			<replace regex="\." replacement="_" />
		</antelope:stringutil>

		<DTDDoc
			destDir="api/definitions"
			showFixmeTags="false"
			showHiddenTags="false"
			sourceDir="definitions"
		>
			<include name="liferay-*${lp.version.dtd}.dtd" />
		</DTDDoc>
	</target>

	<target name="java2html">
		<delete dir="api" />

		<ant dir="portal-kernel" target="java2html" inheritAll="false" />
		<ant dir="portal-service" target="java2html" inheritAll="false" />

		<ant dir="util-bridges" target="java2html" inheritAll="false" />
		<ant dir="util-java" target="java2html" inheritAll="false" />
		<ant dir="util-taglib" target="java2html" inheritAll="false" />

		<ant dir="portal-impl" target="java2html" inheritAll="false" />

		<ant dir="portal-client" target="java2html" inheritAll="false" />
	</target>

	<target name="javadoc">
		<ant dir="portal-kernel" target="javadoc" inheritAll="false" />
		<ant dir="portal-service" target="javadoc" inheritAll="false" />

		<ant dir="util-bridges" target="javadoc" inheritAll="false" />
		<ant dir="util-java" target="javadoc" inheritAll="false" />
		<ant dir="util-taglib" target="javadoc" inheritAll="false" />

		<ant dir="portal-impl" target="javadoc" inheritAll="false" />
	</target>

	<target name="deploy">
		<if>
			<equals arg1="${app.server.type}" arg2="glassfish" />
			<then>
				<delete dir="${app.server.portal.dir}" />
				<delete file="${app.server.portal.dir}" />
			</then>
		</if>

		<ant dir="portal-kernel" target="deploy" inheritAll="false" />
		<ant dir="portal-service" target="deploy" inheritAll="false" />

		<ant dir="util-bridges" target="deploy" inheritAll="false" />
		<ant dir="util-java" target="deploy" inheritAll="false" />
		<ant dir="util-taglib" target="deploy" inheritAll="false" />

		<ant dir="portal-impl" target="deploy" inheritAll="false" />

		<ant dir="portal-web" target="deploy" inheritAll="false" />
		<ant dir="tunnel-web" target="deploy" inheritAll="false" />

		<copy todir="${app.server.dir}/../data/hsql">
			<fileset dir="sql">
				<include name="${database.name}.properties" />
				<include name="${database.name}.script" />
			</fileset>
		</copy>

		<antcall target="deploy-properties" />

		<copy todir="${app.server.lib.global.dir}">
			<fileset dir="lib/development" includes="hsql.jar,jtds.jar,mysql.jar,postgresql.jar" />
			<fileset dir="lib/global" />
		</copy>

		<if>
			<not>
				<equals arg1="${jdbc.drivers.optional.dir}" arg2="$${jdbc.drivers.optional.dir}" />
			</not>
			<then>
				<copy todir="${app.server.lib.global.dir}">
					<fileset
						dir="${jdbc.drivers.optional.dir}"
						includes="*.jar"
					/>
				</copy>
			</then>
		</if>

		<copy todir="${app.server.lib.portal.dir}">
			<fileset dir="lib/portal" />
		</copy>

		<if>
			<equals arg1="${app.server.type}" arg2="glassfish" />
			<then>
				<copy todir="${app.server.lib.global.dir}">
					<fileset
						dir="lib/portal"
						includes="ccpp.jar,log4j.jar"
					/>
				</copy>
			</then>
		</if>

		<if>
			<equals arg1="${app.server.type}" arg2="geronimo-tomcat" />
			<then>
				<copy todir="${app.server.lib.portal.dir}">
					<fileset
						dir="lib/development"
						includes="saxpath.jar"
					/>
				</copy>

				<delete>
					<fileset
						dir="${app.server.lib.portal.dir}"
						includes="commons-logging.jar"
					/>
				</delete>
			</then>
		</if>

		<if>
			<equals arg1="${app.server.type}" arg2="jboss-tomcat" />
			<then>
				<delete>
					<fileset
						dir="${app.server.lib.portal.dir}"
						includes="jaxrpc.jar,stax.jar,xercesImpl.jar,xml-apis.jar"
					/>
				</delete>
			</then>
		</if>

		<if>
			<equals arg1="${app.server.type}" arg2="jetty" />
			<then>
				<copy todir="${app.server.lib.global.dir}">
					<fileset
						dir="lib/development"
						includes="jta.jar"
					/>
				</copy>
			</then>
		</if>

		<if>
			<or>
				<equals arg1="${app.server.type}" arg2="jonas-jetty" />
				<equals arg1="${app.server.type}" arg2="jonas-tomcat" />
			</or>
			<then>
				<copy todir="${app.server.lib.portal.dir}">
					<fileset
						dir="lib/development"
						includes="mail.jar"
					/>
				</copy>
			</then>
		</if>

		<if>
			<equals arg1="${app.server.type}" arg2="resin" />
			<then>
				<copy todir="${app.server.lib.global.dir}">
					<fileset
						dir="lib/development"
						includes="saxpath.jar"
					/>
				</copy>

				<delete>
					<fileset
						dir="${app.server.dir}/lib"
						includes="portlet-10.jar"
					/>
				</delete>
			</then>
		</if>

		<if>
			<equals arg1="${app.server.type}" arg2="tomcat" />
			<then>
				<copy file="classes/log4j.properties" todir="${app.server.classes.portal.dir}" />
				<copy file="classes/logging.properties" todir="${app.server.classes.portal.dir}" />

				<ant dir="support-tomcat" target="deploy" inheritAll="false" />

				<copy todir="${app.server.lib.endorsed.dir}" flatten="true">
					<fileset
						dir="lib"
						includes="${endorsed.libraries}"
					/>
				</copy>

				<delete failonerror="false">
					<fileset
						dir="${app.server.lib.portal.dir}"
						includes="ccpp.jar"
					/>
				</delete>

				<copy todir="${app.server.lib.global.dir}">
					<fileset
						dir="lib/development"
						includes="activation.jar,jms.jar,jta.jar,mail.jar"
					/>
				</copy>

				<if>
					<equals arg1="${app.server.version}" arg2="5.5" />
					<then>

						<!--
						LEP-2981
						-->

						<copy todir="${app.server.dir}/common/lib">
							<fileset
								dir="lib/development"
								includes="naming-factory.jar"
							/>
						</copy>
					</then>
				</if>

				<copy todir="${app.server.temp.dir}/liferay/com/liferay/portal/deploy/dependencies">
					<fileset
						dir="lib/development"
						includes="quercus.jar,resin-util.jar,script-10.jar"
					/>
				</copy>

				<if>
					<not>
						<available file="${app.server.dir}/conf/Catalina/localhost/${app.server.tomcat.portal.context}.xml" />
					</not>
					<then>
						<copy
							file="tools/servers/tomcat/conf/Catalina/localhost/ROOT.xml"
							tofile="${app.server.dir}/conf/Catalina/localhost/${app.server.tomcat.portal.context}.xml"
							overwrite="yes"
						/>
					</then>
				</if>

				<copy
					file="tools/servers/tomcat/conf/catalina.properties.${app.server.version}"
					tofile="${app.server.dir}/conf/catalina.properties"
					overwrite="yes"
				/>

				<copy
					file="tools/servers/tomcat/conf/jaas.config"
					tofile="${app.server.dir}/conf/jaas.config"
				/>
			</then>
		</if>

		<mkdir dir="${app.server.log.dir}" />
		<mkdir dir="${app.server.temp.dir}" />
		<mkdir dir="${app.server.work.dir}" />

		<if>
			<equals arg1="${app.server.type}" arg2="glassfish" />
			<then>
				<tstamp>
					<format property="tstamp.value" pattern="yyyyMMddkkmmssSSS" />
				</tstamp>

				<jar
					basedir="${app.server.portal.dir}"
					jarfile="${tstamp.value}"
				/>

				<delete dir="${app.server.portal.dir}" />

				<move file="${tstamp.value}" tofile="${app.server.portal.dir}" />
			</then>
		</if>

		<antcall target="print-current-time" />
	</target>

	<target name="deploy-properties">
		<copy todir="${app.server.classes.portal.dir}" overwrite="yes">
			<fileset dir="portal-impl/src" includes="portal-*.properties,system-*.properties" />
		</copy>
	</target>

	<target name="build-ext">
		<available file="${lp.ext.dir}/modules" type="dir" property="lp.ext.dir.available" />

		<antcall target="build-ext-dir" />

		<if>
			<not>
				<available file="${lp.ext.dir}/ext-service" type="dir" />
			</not>
			<then>
				<mkdir dir="${lp.ext.dir}/ext-service" />

				<copy todir="${lp.ext.dir}/ext-service" filtering="true">
					<fileset dir="tools/ext_tmpl/ext-service" />
				</copy>
			</then>
		</if>

		<copy todir="${lp.ext.dir}" preservelastmodified="true">
			<fileset
				dir="."
				includes="app.server.properties,release.properties"
			/>
			<fileset
				dir="tools/ext_tmpl"
				includes=".classpath,.project,readme.txt,build.properties,**/build-common*.xml,**/build-parent.xml"
			/>
			<filterset>
				<filter token="lp.version" value="${lp.version}" />
				<filter token="lp.version" value="${lp.version}" />
				<filter token="lp.eclipse.project.name" value="${lp.eclipse.project.name}" />
			</filterset>
		</copy>

		<mkdir dir="${lp.ext.dir}/ext-lib" />
		<mkdir dir="${lp.ext.dir}/ext-lib/development" />
		<mkdir dir="${lp.ext.dir}/ext-lib/global" />
		<mkdir dir="${lp.ext.dir}/ext-lib/portal" />

		<copy file="lib/readme.txt" todir="${lp.ext.dir}/ext-lib" />

		<sync includeemptydirs="true" todir="${lp.ext.dir}/lib" verbose="true">
			<fileset dir="lib" />
			<preserveintarget>
				<include name="**/.svn" />
				<include name="**/.svn/**" />
			</preserveintarget>
		</sync>

		<copy todir="${lp.ext.dir}/lib/development" preservelastmodified="true">
			<fileset dir="support-tomcat" includes="support-tomcat.jar" />
		</copy>

		<copy todir="${lp.ext.dir}/lib/global" preservelastmodified="true">
			<fileset dir="portal-kernel" includes="portal-kernel.jar" />
			<fileset dir="portal-service" includes="portal-service.jar" />
		</copy>

		<copy todir="${lp.ext.dir}/lib/portal" preservelastmodified="true">
			<fileset dir="util-bridges" includes="util-bridges.jar" />
			<fileset dir="util-java" includes="util-java.jar" />
			<fileset dir="util-taglib" includes="util-taglib.jar" />
		</copy>

		<copy todir="${lp.ext.dir}/modules" preservelastmodified="true">
			<fileset dir="portal-impl" includes="portal-impl.jar" />
			<fileset dir="portal-web" includes="portal-web.war" />
			<fileset dir="tunnel-web" includes="tunnel-web.war" />
		</copy>

		<ant dir="sql" target="build-db" inheritAll="false" />
		<ant dir="sql" target="rebuild-hypersonic" inheritAll="false" />

		<copy todir="${lp.ext.dir}/sql" overwrite="yes">
			<fileset dir="sql">
				<exclude name="**/log/**" />
			</fileset>
		</copy>

		<copy todir="${lp.ext.dir}/tools" overwrite="yes">
			<fileset dir="tools" includes="java2html.bat,javadoc.css" />
		</copy>

		<antcall target="print-current-time" />
	</target>

	<target name="build-ext-dir" unless="lp.ext.dir.available">
		<filter token="lp.eclipse.project.name" value="${lp.eclipse.project.name}" />

		<copy todir="${lp.ext.dir}" filtering="true" preservelastmodified="true">
			<fileset dir="tools/ext_tmpl" />
		</copy>
	</target>

	<target name="dist">
		<ant antfile="build-dist.xml" target="dist" inheritAll="false" />
	</target>

	<target name="prepare-generated-files">
		<ant antfile="build-dist.xml" target="prepare-generated-files" inheritAll="false" />
	</target>

	<target name="test">
		<ant antfile="build-test.xml" target="test" inheritAll="false" />
	</target>

	<target name="validate-xml">
		<xmlvalidate failonerror="no">
			<fileset dir="${project.dir}"
				excludes="**/dependencies/**,**/ehcache/**"
				includes="**/liferay-*.xml,**/web.xml"
			/>
			<xmlcatalog refid="dtd.catalog" />
		</xmlvalidate>
	</target>
</project>